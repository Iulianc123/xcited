name: Setup xcited Environment Variables

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/setup-env.yml'
      - '.github/TRIGGER_XCITED_SETUP'

jobs:
  setup-env:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Create .env.production
        run: |
          echo "NODE_ENV=production" > .env.production
          echo "PORT=3002" >> .env.production
          echo "" >> .env.production
          echo "# Database" >> .env.production
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env.production
          echo "" >> .env.production
          echo "# NextAuth" >> .env.production
          echo "NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}" >> .env.production
          echo "NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL || 'https://xcited.ro' }}" >> .env.production
          echo "" >> .env.production
          echo "# Email (for NextAuth)" >> .env.production
          echo "EMAIL_SERVER_HOST=${{ secrets.EMAIL_SERVER_HOST }}" >> .env.production
          echo "EMAIL_SERVER_PORT=${{ secrets.EMAIL_SERVER_PORT }}" >> .env.production
          echo "EMAIL_SERVER_USER=${{ secrets.EMAIL_SERVER_USER }}" >> .env.production
          echo "EMAIL_SERVER_PASSWORD=${{ secrets.EMAIL_SERVER_PASSWORD }}" >> .env.production
          echo "EMAIL_FROM=${{ secrets.EMAIL_FROM }}" >> .env.production
          
          echo "‚úÖ .env.production created"
          echo ""
          echo "üìÑ Content (sensitive values hidden):"
          sed 's/=.*/=***/' .env.production

      - name: Deploy .env.production to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.CWP_HOST }}
          username: ${{ secrets.CWP_USER }}
          password: ${{ secrets.CWP_SSH_KEY }}
          port: ${{ secrets.CWP_PORT || 22 }}
          source: ".env.production"
          target: "/home/xcited/public_html/.env.production"
          rm: false

      - name: Update PM2 config and restart
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.CWP_HOST }}
          username: ${{ secrets.CWP_USER }}
          password: ${{ secrets.CWP_SSH_KEY }}
          port: ${{ secrets.CWP_PORT || 22 }}
          script: |
            set -e
            cd /home/xcited/public_html
            
            echo "‚úÖ .env.production deployed"
            
            # Create/update ecosystem.config.js (for standalone build)
            echo 'module.exports = {' > ecosystem.config.js
            echo '  apps: [{' >> ecosystem.config.js
            echo "    name: 'xcited-web'," >> ecosystem.config.js
            echo "    script: 'server.js'," >> ecosystem.config.js
            echo "    cwd: '/home/xcited/public_html'," >> ecosystem.config.js
            echo '    instances: 2,' >> ecosystem.config.js
            echo "    exec_mode: 'cluster'," >> ecosystem.config.js
            echo '    env: {' >> ecosystem.config.js
            echo "      NODE_ENV: 'production'," >> ecosystem.config.js
            echo '      PORT: 3002' >> ecosystem.config.js
            echo '    },' >> ecosystem.config.js
            echo "    error_file: '/var/log/pm2/xcited-web-error.log'," >> ecosystem.config.js
            echo "    out_file: '/var/log/pm2/xcited-web-out.log'," >> ecosystem.config.js
            echo "    log_date_format: 'YYYY-MM-DD HH:mm:ss Z'," >> ecosystem.config.js
            echo '    merge_logs: true,' >> ecosystem.config.js
            echo '    autorestart: true,' >> ecosystem.config.js
            echo "    max_memory_restart: '1G'" >> ecosystem.config.js
            echo '  }]' >> ecosystem.config.js
            echo '}' >> ecosystem.config.js
            
            echo "‚úÖ ecosystem.config.js updated"
            echo ""
            echo "üîÑ Restarting application..."
            pm2 delete xcited-web 2>/dev/null || true
            
            # Start with ecosystem.config.js if server.js exists, otherwise wait for deploy
            if [ -f "server.js" ]; then
              pm2 start ecosystem.config.js
              pm2 save
              echo "‚úÖ Application restarted!"
            else
              echo "‚ö†Ô∏è  server.js not found yet. Will start after first deploy."
            fi

