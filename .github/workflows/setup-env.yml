name: Setup xcited Environment Variables

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/setup-env.yml'
      - '.github/TRIGGER_XCITED_SETUP'

jobs:
  setup-env:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Create .env.production
        run: |
          cat > .env.production << EOF
NODE_ENV=production
PORT=3001

# Database
DATABASE_URL=${{ secrets.DATABASE_URL }}

# NextAuth
NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL || 'https://xcited.ro' }}

# Email (for NextAuth)
EMAIL_SERVER_HOST=${{ secrets.EMAIL_SERVER_HOST }}
EMAIL_SERVER_PORT=${{ secrets.EMAIL_SERVER_PORT }}
EMAIL_SERVER_USER=${{ secrets.EMAIL_SERVER_USER }}
EMAIL_SERVER_PASSWORD=${{ secrets.EMAIL_SERVER_PASSWORD }}
EMAIL_FROM=${{ secrets.EMAIL_FROM }}
EOF
          
          echo "‚úÖ .env.production created"
          echo ""
          echo "üìÑ Content (sensitive values hidden):"
          sed 's/=.*/=***/' .env.production

      - name: Deploy .env.production to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.CWP_PROD_HOST }}
          username: ${{ secrets.CWP_PROD_USER }}
          key: ${{ secrets.CWP_PROD_SSH_KEY }}
          port: ${{ secrets.CWP_PROD_PORT || 22 }}
          source: ".env.production"
          target: "/home/xcited/public_html/.env.production"
          rm: false

      - name: Update PM2 config and restart
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.CWP_PROD_HOST }}
          username: ${{ secrets.CWP_PROD_USER }}
          key: ${{ secrets.CWP_PROD_SSH_KEY }}
          port: ${{ secrets.CWP_PROD_PORT || 22 }}
          script: |
            set -e
            cd /home/xcited/public_html
            
            echo "‚úÖ .env.production deployed"
            
            # Create/update ecosystem.config.js (for standalone build)
            cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'xcited-web',
    script: 'server.js',
    cwd: '/home/xcited/public_html',
    instances: 2,
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3001
    },
    error_file: '/var/log/pm2/xcited-web-error.log',
    out_file: '/var/log/pm2/xcited-web-out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    merge_logs: true,
    autorestart: true,
    max_memory_restart: '1G'
  }]
}
EOF
            
            echo "‚úÖ ecosystem.config.js updated"
            echo ""
            echo "üîÑ Restarting application..."
            pm2 delete xcited-web 2>/dev/null || true
            
            # Start with ecosystem.config.js if server.js exists, otherwise wait for deploy
            if [ -f "server.js" ]; then
              pm2 start ecosystem.config.js
              pm2 save
              echo "‚úÖ Application restarted!"
            else
              echo "‚ö†Ô∏è  server.js not found yet. Will start after first deploy."
            fi

