name: Deploy xcited to Production

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate || echo "âš ï¸  Prisma generate failed (continuing without DB)"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://user:pass@localhost:5432/xcited' }}

      - name: Build Next.js app
        run: npm run build
        env:
          NODE_ENV: production
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://user:pass@localhost:5432/xcited' }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET || 'xcited-temp-secret-key-min-32-chars-long-for-build' }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL || 'https://xcited.ro' }}

      - name: Create deployment package
        run: |
          rm -rf deploy-package
          mkdir -p deploy-package
          
          # Next.js standalone output (like 1dream)
          if [ -d ".next/standalone" ]; then
            echo "âœ… Found standalone build"
            cp -R .next/standalone/* deploy-package/
            
            # Static assets must be copied into the standalone folder structure
            mkdir -p deploy-package/.next
            cp -R .next/static deploy-package/.next/static
            
            # public/ is optional in Next.js projects
            if [ -d "public" ]; then
              cp -R public deploy-package/public
            fi
          else
            echo "âš ï¸  No standalone build, using regular build"
            cp -r .next deploy-package/
            if [ -d "public" ]; then
              cp -r public deploy-package/
            fi
          fi
          
          # Copy necessary files
          if [ -d "prisma" ]; then
            cp -r prisma deploy-package/
          fi
          cp package.json deploy-package/
          cp package-lock.json deploy-package/ 2>/dev/null || true
          cp next.config.ts deploy-package/
          cp tsconfig.json deploy-package/
          
          # Copy Prisma generated client
          if [ -d "node_modules/.prisma" ]; then
            mkdir -p deploy-package/node_modules
            cp -r node_modules/.prisma deploy-package/node_modules/ 2>/dev/null || true
          fi
          
          # Create ecosystem.config.js for PM2 (like 1dream)
          cat > deploy-package/ecosystem.config.js << 'PM2CONFIG'
module.exports = {
  apps: [{
    name: 'xcited-web',
    script: 'server.js',
    cwd: '/home/xcited/public_html',
    instances: 2,
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3001
    },
    error_file: '/var/log/pm2/xcited-web-error.log',
    out_file: '/var/log/pm2/xcited-web-out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    merge_logs: true,
    autorestart: true,
    max_memory_restart: '1G'
  }]
}
PM2CONFIG

      - name: Deploy to CWP7pro Production
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.CWP_PROD_HOST }}
          username: ${{ secrets.CWP_PROD_USER }}
          key: ${{ secrets.CWP_PROD_SSH_KEY }}
          port: ${{ secrets.CWP_PROD_PORT || 22 }}
          source: "deploy-package/*"
          target: "/home/xcited/public_html"
          rm: true

      - name: Run post-deploy on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.CWP_PROD_HOST }}
          username: ${{ secrets.CWP_PROD_USER }}
          key: ${{ secrets.CWP_PROD_SSH_KEY }}
          port: ${{ secrets.CWP_PROD_PORT || 22 }}
          script: |
            set -e
            cd /home/xcited/public_html
            
            echo "== Verify deployed files =="
            pwd
            ls -la || true
            
            echo "== Installing production dependencies (like 1dream) =="
            if [ -f "package-lock.json" ]; then
              npm ci --production --frozen-lockfile || npm install --production
            else
              npm install --production
            fi
            
            echo "== Generating Prisma Client =="
            if [ -d "prisma" ]; then
              npx prisma generate || echo "âš ï¸  Prisma generate failed (continuing...)"
            fi
            
            echo "== Running Prisma migrations =="
            if [ -d "prisma" ] && [ -n "${{ secrets.DATABASE_URL }}" ] && [ "${{ secrets.DATABASE_URL }}" != "postgresql://user:pass@localhost:5432/xcited" ]; then
              DATABASE_URL="${{ secrets.DATABASE_URL }}" npx prisma migrate deploy || echo "âš ï¸  Migrations failed (continuing...)"
            else
              echo "âš ï¸  Skipping migrations (no DATABASE_URL secret or placeholder)"
            fi
            
            echo "== Restarting application with PM2 (like 1dream) =="
            export PORT=3001
            export NODE_ENV=production
            
            # Check if server.js exists (standalone build)
            if [ -f "server.js" ]; then
              SCRIPT="server.js"
            else
              echo "âŒ ERROR: server.js not found!"
              echo "ðŸ“‹ Files in directory:"
              ls -la
              exit 1
            fi
            
            # Restart or start PM2 (like 1dream)
            if pm2 describe xcited-web >/dev/null 2>&1; then
              pm2 restart xcited-web --update-env
            else
              pm2 start "${SCRIPT}" --name xcited-web
            fi
            
            pm2 save
            pm2 list
            
            echo "âœ… Deployment completed successfully!"

