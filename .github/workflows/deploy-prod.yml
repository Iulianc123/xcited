name: Deploy xcited to Production

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/TRIGGER_DEPLOY'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate || echo "âš ï¸  Prisma generate failed (continuing without DB)"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://user:pass@localhost:5432/xcited' }}

      - name: Build Next.js app
        run: npm run build
        env:
          NODE_ENV: production
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://user:pass@localhost:5432/xcited' }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET || 'xcited-temp-secret-key-min-32-chars-long-for-build' }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL || 'https://xcited.ro' }}

      - name: Create deployment package
        run: |
          rm -rf deploy-package
          mkdir -p deploy-package
          
          # Next.js standalone output (like 1dream)
          if [ -d ".next/standalone" ]; then
            echo "âœ… Found standalone build"
            cp -R .next/standalone/* deploy-package/
            
            # Static assets must be copied into the standalone folder structure
            mkdir -p deploy-package/.next
            cp -R .next/static deploy-package/.next/static
            
            # public/ is optional in Next.js projects
            if [ -d "public" ]; then
              cp -R public deploy-package/public
            fi
          else
            echo "âš ï¸  No standalone build, using regular build"
            cp -r .next deploy-package/
            if [ -d "public" ]; then
              cp -r public deploy-package/
            fi
          fi
          
          # Copy necessary files
          if [ -d "prisma" ]; then
            cp -r prisma deploy-package/
          fi
          cp package.json deploy-package/
          cp package-lock.json deploy-package/ 2>/dev/null || true
          cp next.config.ts deploy-package/
          cp tsconfig.json deploy-package/
          
          # Copy Prisma generated client
          if [ -d "node_modules/.prisma" ]; then
            mkdir -p deploy-package/node_modules
            cp -r node_modules/.prisma deploy-package/node_modules/ 2>/dev/null || true
          fi
          
          # Create ecosystem.config.js for PM2 (like 1dream - using echo to avoid YAML issues)
          echo 'module.exports = {' > deploy-package/ecosystem.config.js
          echo '  apps: [{' >> deploy-package/ecosystem.config.js
          echo "    name: 'xcited-web'," >> deploy-package/ecosystem.config.js
          echo "    script: 'server.js'," >> deploy-package/ecosystem.config.js
          echo "    cwd: '/home/xcited/public_html'," >> deploy-package/ecosystem.config.js
          echo '    instances: 2,' >> deploy-package/ecosystem.config.js
          echo "    exec_mode: 'cluster'," >> deploy-package/ecosystem.config.js
          echo "    interpreter: 'node'," >> deploy-package/ecosystem.config.js
          echo '    env: {' >> deploy-package/ecosystem.config.js
          echo "      NODE_ENV: 'production'," >> deploy-package/ecosystem.config.js
          echo '      PORT: 3001' >> deploy-package/ecosystem.config.js
          echo '    },' >> deploy-package/ecosystem.config.js
          echo "    error_file: '/var/log/pm2/xcited-web-error.log'," >> deploy-package/ecosystem.config.js
          echo "    out_file: '/var/log/pm2/xcited-web-out.log'," >> deploy-package/ecosystem.config.js
          echo "    log_date_format: 'YYYY-MM-DD HH:mm:ss Z'," >> deploy-package/ecosystem.config.js
          echo '    merge_logs: true,' >> deploy-package/ecosystem.config.js
          echo '    autorestart: true,' >> deploy-package/ecosystem.config.js
          echo "    max_memory_restart: '1G'" >> deploy-package/ecosystem.config.js
          echo '  }]' >> deploy-package/ecosystem.config.js
          echo '}' >> deploy-package/ecosystem.config.js

      - name: Pre-deploy Ensure directory permissions
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.CWP_HOST }}
          username: ${{ secrets.CWP_USER }}
          password: ${{ secrets.CWP_SSH_KEY }}
          port: ${{ secrets.CWP_PORT || 22 }}
          script: |
            set -e
            TARGET="/home/xcited/public_html"
            OWNER_USER="xcited"
            OWNER_GROUP="xcited"
            
            echo "== Pre-deploy: Ensure directory is ready =="
            
            # Verify user exists
            if ! id -u "${OWNER_USER}" >/dev/null 2>&1; then
              echo "âš ï¸  ERROR: user '${OWNER_USER}' does not exist!"
              exit 1
            fi
            
            # Ensure target directory exists and has correct ownership
            mkdir -p "${TARGET}"
            
            # Set ownership BEFORE SCP (critical!)
            echo "ðŸ”§ Setting ownership BEFORE SCP..."
            if sudo -n true 2>/dev/null; then
              sudo -n chown -R "${OWNER_USER}:${OWNER_GROUP}" "${TARGET}" || true
              sudo -n chmod -R u+rwX "${TARGET}" || true
            else
              chown -R "${OWNER_USER}:${OWNER_GROUP}" "${TARGET}" || true
              chmod -R u+rwX "${TARGET}" || true
            fi
            
            # Verify writable
            if ! ( touch "${TARGET}/.gha_write_test" && rm -f "${TARGET}/.gha_write_test" ); then
              echo "âš ï¸  WARN: ${TARGET} is not writable"
              if sudo -n true 2>/dev/null; then
                sudo -n chown -R "${OWNER_USER}:${OWNER_GROUP}" "${TARGET}" || true
                sudo -n chmod -R u+rwX "${TARGET}" || true
              fi
            fi
            
            echo "âœ… Directory ready for SCP"

      - name: Deploy to CWP7pro Production
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.CWP_HOST }}
          username: ${{ secrets.CWP_USER }}
          password: ${{ secrets.CWP_SSH_KEY }}
          port: ${{ secrets.CWP_PORT || 22 }}
          source: "deploy-package/*"
          target: "/home/xcited/public_html"
          rm: true

      - name: Run post-deploy script on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.CWP_HOST }}
          username: ${{ secrets.CWP_USER }}
          password: ${{ secrets.CWP_SSH_KEY }}
          port: ${{ secrets.CWP_PORT || 22 }}
          script: |
            set -e
            # Note: This script runs as the user specified in CWP_USER (usually root)
            # We use sudo where needed, but most commands should work as root
            
            TARGET="/home/xcited/public_html"
            OWNER_USER="xcited"
            OWNER_GROUP="xcited"
            
            # Get current user (should be root)
            REMOTE_USER="$(id -un)"
            REMOTE_GROUP="$(id -gn)"
            
            echo "== Remote identity =="
            whoami
            id
            
            # Verify xcited user exists (should exist since domain exists)
            if ! id -u "${OWNER_USER}" >/dev/null 2>&1; then
              echo "âš ï¸  ERROR: user '${OWNER_USER}' does not exist!"
              echo "   User should exist since domain xcited.ro exists in CWP7pro"
              echo "   Please verify user exists or create it manually"
              exit 1
            fi
            if ! getent group "${OWNER_GROUP}" >/dev/null 2>&1; then
              echo "âš ï¸  WARN: group '${OWNER_GROUP}' does not exist. Creating group..."
              groupadd "${OWNER_GROUP}" 2>/dev/null || {
                echo "   Group creation failed, using existing group for user"
                OWNER_GROUP=$(id -gn "${OWNER_USER}")
              }
            fi
            
            echo "== Ensure target directory exists =="
            mkdir -p "${TARGET}"
            
            echo "== Set correct ownership and permissions (POST-SCP) =="
            # CRITICAL: SCP may copy files as root, so we MUST fix ownership after SCP
            # Use sudo -n (non-interactive) to ensure it works even if we're already root
            echo "ðŸ”§ Setting ownership to ${OWNER_USER}:${OWNER_GROUP}..."
            
            # Use sudo -n (non-interactive) like 1dream does
            if sudo -n true 2>/dev/null; then
              echo "   Using sudo -n (non-interactive)..."
              sudo -n chown -R "${OWNER_USER}:${OWNER_GROUP}" "${TARGET}" || {
                echo "âš ï¸  sudo -n chown failed, trying without -n..."
                sudo chown -R "${OWNER_USER}:${OWNER_GROUP}" "${TARGET}" || {
                  echo "âŒ Ownership change failed"
                  exit 1
                }
              }
            else
              # If we're already root, chown should work directly
              chown -R "${OWNER_USER}:${OWNER_GROUP}" "${TARGET}" || {
                echo "âŒ Ownership change failed (not root and no sudo)"
                exit 1
              }
            fi
            
            # Verify ownership was set correctly
            echo "ðŸ” Verifying ownership..."
            WRONG_OWNER=$(find "${TARGET}" ! -user "${OWNER_USER}" -o ! -group "${OWNER_GROUP}" 2>/dev/null | head -10)
            if [ -n "$WRONG_OWNER" ]; then
              echo "âš ï¸  WARNING: Some files still have wrong ownership:"
              echo "$WRONG_OWNER"
              echo "   Attempting aggressive fix..."
              if sudo -n true 2>/dev/null; then
                sudo -n find "${TARGET}" ! -user "${OWNER_USER}" -exec chown "${OWNER_USER}:${OWNER_GROUP}" {} \; 2>/dev/null || true
                sudo -n find "${TARGET}" ! -group "${OWNER_GROUP}" -exec chgrp "${OWNER_GROUP}" {} \; 2>/dev/null || true
              fi
            else
              echo "âœ… All files have correct ownership: ${OWNER_USER}:${OWNER_GROUP}"
            fi
            
            # Set correct permissions for directories and files (like 1dream)
            echo "ðŸ”§ Setting permissions..."
            if sudo -n true 2>/dev/null; then
              sudo -n find "${TARGET}" -type d -exec chmod 755 {} \; || true
              sudo -n find "${TARGET}" -type f -exec chmod 644 {} \; || true
              sudo -n chmod -R u+rwX "${TARGET}" || true
            else
              find "${TARGET}" -type d -exec chmod 755 {} \; || true
              find "${TARGET}" -type f -exec chmod 644 {} \; || true
              chmod -R u+rwX "${TARGET}" || true
            fi
            
            # Final verification
            echo "ðŸ” Final ownership verification..."
            ls -ld "${TARGET}"
            ls -la "${TARGET}" | head -10
            echo "   Owner: $(stat -c '%U:%G' "${TARGET}" 2>/dev/null || echo 'unknown')"
            echo "   Permissions: $(stat -c '%a' "${TARGET}" 2>/dev/null || echo 'unknown')"
            
            echo "âœ… Permissions set correctly"
            echo "   Owner: ${OWNER_USER}:${OWNER_GROUP}"
            echo "   Target: ${TARGET}"
            
            cd "${TARGET}"
            
            echo "âœ… Files deployed"
            
            # CRITICAL: Ensure Node.js 18+ is available (Next.js 16 requires Node 18+)
            echo "ðŸ” Checking Node.js version..."
            if ! command -v node >/dev/null 2>&1; then
              echo "âš ï¸  Node.js not found. Installing Node.js 20..."
              curl -fsSL https://rpm.nodesource.com/setup_20.x | bash - || echo "âš ï¸  Node.js setup failed"
              yum install -y nodejs || echo "âš ï¸  Node.js install failed"
            else
              NODE_VERSION=$(node -v 2>/dev/null || echo "v0.0.0")
              NODE_MAJOR=$(echo "$NODE_VERSION" | cut -d'v' -f2 | cut -d'.' -f1)
              echo "   Current Node.js version: $NODE_VERSION (major: $NODE_MAJOR)"
              
              if [ "$NODE_MAJOR" -lt 18 ]; then
                echo "âš ï¸  Node.js version $NODE_VERSION is too old (Next.js 16 requires Node 18+)"
                echo "   Installing Node.js 20..."
                curl -fsSL https://rpm.nodesource.com/setup_20.x | bash - || echo "âš ï¸  Node.js setup failed"
                yum install -y nodejs || echo "âš ï¸  Node.js install failed"
                echo "   New Node.js version: $(node -v 2>/dev/null || echo 'unknown')"
              else
                echo "âœ… Node.js version is compatible: $NODE_VERSION"
              fi
            fi
            
            # Verify Node.js is accessible and get full path
            NODE_PATH=$(which node 2>/dev/null || echo "")
            if [ -z "$NODE_PATH" ]; then
              echo "âŒ ERROR: Node.js not found in PATH"
              echo "   This will cause PM2 to fail"
              exit 1
            fi
            
            NODE_VERSION=$(node -v 2>/dev/null || echo "unknown")
            echo "   Node.js path: $NODE_PATH"
            echo "   Node.js version: $NODE_VERSION"
            
            # CRITICAL: If nvm is being used, we need to ensure PM2 uses the correct Node.js
            # Check if nvm is active and if so, use the system Node.js instead
            if echo "$NODE_PATH" | grep -q "nvm"; then
              echo "âš ï¸  WARN: nvm is active, Node.js path: $NODE_PATH"
              echo "   This may cause PM2 to use wrong Node.js version"
              echo "   Checking for system Node.js..."
              
              # Try to find system Node.js (usually in /usr/bin/node or /usr/local/bin/node)
              SYSTEM_NODE=""
              for path in /usr/bin/node /usr/local/bin/node /opt/nodejs/bin/node; do
                if [ -f "$path" ]; then
                  SYS_VERSION=$($path -v 2>/dev/null || echo "")
                  if [ -n "$SYS_VERSION" ]; then
                    SYS_MAJOR=$(echo "$SYS_VERSION" | cut -d'v' -f2 | cut -d'.' -f1)
                    if [ "$SYS_MAJOR" -ge 18 ]; then
                      SYSTEM_NODE="$path"
                      echo "   âœ… Found system Node.js $SYS_VERSION at: $SYSTEM_NODE"
                      NODE_PATH="$SYSTEM_NODE"
                      break
                    fi
                  fi
                fi
              done
              
              # If no system Node.js found, install it
              if [ -z "$SYSTEM_NODE" ]; then
                echo "   Installing Node.js 20 system-wide..."
                curl -fsSL https://rpm.nodesource.com/setup_20.x | bash - || echo "âš ï¸  Node.js setup failed"
                yum install -y nodejs || echo "âš ï¸  Node.js install failed"
                NODE_PATH=$(which node 2>/dev/null || echo "/usr/bin/node")
                echo "   New Node.js path: $NODE_PATH"
                echo "   New Node.js version: $(node -v 2>/dev/null || echo 'unknown')"
              fi
            fi
            
            # Final verification
            FINAL_VERSION=$($NODE_PATH -v 2>/dev/null || echo "unknown")
            FINAL_MAJOR=$(echo "$FINAL_VERSION" | cut -d'v' -f2 | cut -d'.' -f1)
            if [ "$FINAL_MAJOR" -lt 18 ]; then
              echo "âŒ ERROR: Node.js version $FINAL_VERSION is still too old (requires 18+)"
              echo "   Path: $NODE_PATH"
              exit 1
            fi
            
            echo "âœ… Using Node.js $FINAL_VERSION from: $NODE_PATH"
            
            # Install dependencies (for standalone build, minimal install needed)
            if [ -f "package.json" ]; then
              npm install --production || npm ci --production --frozen-lockfile || echo "âš ï¸  npm install failed (continuing...)"
            fi
            
            # Prisma setup
            if [ -d "prisma" ]; then
              npx prisma generate || echo "âš ï¸  Prisma generate failed (continuing...)"
              if [ -n "${{ secrets.DATABASE_URL }}" ] && [ "${{ secrets.DATABASE_URL }}" != "postgresql://user:pass@localhost:5432/xcited" ]; then
                DATABASE_URL="${{ secrets.DATABASE_URL }}" npx prisma migrate deploy || echo "âš ï¸  Migrations failed (continuing...)"
              fi
            fi
            
            # CRITICAL: Ensure PM2 uses Node.js 20
            echo "ðŸ” Checking PM2 Node.js version..."
            PM2_NODE=$(pm2 describe pm2 2>/dev/null | grep "interpreter" | head -1 | awk '{print $2}' || echo "")
            if [ -z "$PM2_NODE" ]; then
              PM2_NODE=$(which node 2>/dev/null || echo "")
            fi
            
            echo "   PM2 is using Node.js: $PM2_NODE"
            if [ -n "$PM2_NODE" ]; then
              PM2_NODE_VER=$($PM2_NODE -v 2>/dev/null || echo "unknown")
              PM2_NODE_MAJOR=$(echo "$PM2_NODE_VER" | cut -d'v' -f2 | cut -d'.' -f1)
              echo "   PM2 Node.js version: $PM2_NODE_VER (major: $PM2_NODE_MAJOR)"
              
              if [ "$PM2_NODE_MAJOR" -lt 18 ] || echo "$PM2_NODE" | grep -q "nvm"; then
                echo "âš ï¸  CRITICAL: PM2 is using Node.js v14 from nvm"
                echo "   Reinstalling PM2 with system Node.js 20..."
                
                # Find or install system Node.js 20
                SYSTEM_NODE=""
                for path in /usr/bin/node /usr/local/bin/node /opt/nodejs/bin/node; do
                  if [ -f "$path" ]; then
                    VER=$($path -v 2>/dev/null || echo "")
                    if [ -n "$VER" ]; then
                      MAJOR=$(echo "$VER" | cut -d'v' -f2 | cut -d'.' -f1)
                      if [ "$MAJOR" -ge 18 ]; then
                        SYSTEM_NODE="$path"
                        echo "   âœ… Found system Node.js $VER at: $SYSTEM_NODE"
                        break
                      fi
                    fi
                  fi
                done
                
                if [ -z "$SYSTEM_NODE" ]; then
                  echo "   Installing Node.js 20 system-wide..."
                  curl -fsSL https://rpm.nodesource.com/setup_20.x | bash - || echo "âš ï¸  Node.js setup failed"
                  yum install -y nodejs || echo "âš ï¸  Node.js install failed"
                  SYSTEM_NODE="/usr/bin/node"
                fi
                
                # Reinstall PM2 with system Node.js 20
                echo "   Reinstalling PM2 with $SYSTEM_NODE..."
                export PATH="/usr/bin:/usr/local/bin:/opt/nodejs/bin:$PATH"
                $SYSTEM_NODE -v
                npm uninstall -g pm2 2>/dev/null || true
                $SYSTEM_NODE $(which npm 2>/dev/null || echo "/usr/bin/npm") install -g pm2 || {
                  echo "   âš ï¸  PM2 reinstall failed, trying alternative..."
                  /usr/bin/npm install -g pm2 || echo "   âš ï¸  Alternative PM2 install also failed"
                }
                
                # Verify PM2 now uses correct Node.js
                NEW_PM2_NODE=$(which pm2 2>/dev/null || echo "")
                if [ -n "$NEW_PM2_NODE" ]; then
                  echo "   âœ… PM2 reinstalled at: $NEW_PM2_NODE"
                fi
              else
                echo "   âœ… PM2 is using correct Node.js version"
              fi
            fi
            
            # PM2 management
            echo "ðŸ”„ Managing PM2 process..."
            pm2 delete xcited-web 2>/dev/null || true
            
            # Set PATH to prioritize system Node.js
            export PATH="/usr/bin:/usr/local/bin:/opt/nodejs/bin:$PATH"
            echo "   Using PATH: $PATH"
            echo "   Node.js: $(which node) ($(node -v 2>/dev/null || echo 'unknown'))"
            
            # Find server.js in standalone build structure (exclude node_modules)
            SERVER_JS=""
            if [ -f "server.js" ]; then
              SERVER_JS="server.js"
            elif [ -f ".next/standalone/server.js" ]; then
              SERVER_JS=".next/standalone/server.js"
            elif [ -f "standalone/server.js" ]; then
              SERVER_JS="standalone/server.js"
            else
              echo "ðŸ” Searching for server.js (excluding node_modules)..."
              SERVER_JS=$(find . -name "server.js" -type f -not -path "*/node_modules/*" | head -1)
            fi
            
            if [ -z "$SERVER_JS" ] || [ ! -f "$SERVER_JS" ]; then
              echo "âš ï¸  server.js not found"
              echo "ðŸ“ Current directory structure:"
              ls -la
              echo ""
              echo "ðŸ” Searching for server.js (excluding node_modules)..."
              find . -name "server.js" -type f -not -path "*/node_modules/*" || echo "No server.js found"
              echo ""
              echo "âš ï¸  Cannot start PM2 without server.js"
              echo "ðŸ’¡ VerificÄƒ dacÄƒ build-ul standalone a fost creat corect"
              exit 1
            fi
            
            echo "âœ… Found server.js at: $SERVER_JS"
            
            # Use PM2 directly like wishhub does (simpler and more reliable)
            # Wishhub doesn't use ecosystem.config.js, it uses pm2 start directly
            echo "ðŸ“‹ Starting PM2 directly (like wishhub)..."
            
            # Set PATH to prioritize system Node.js
            export PATH="/usr/bin:/usr/local/bin:/opt/nodejs/bin:$PATH"
            export NODE_ENV="production"
            export PORT="3001"
            
            echo "   Using Node.js: $(which node) ($(node -v 2>/dev/null || echo 'unknown'))"
            echo "   Script: $SERVER_JS"
            echo "   Working directory: $(pwd)"
            
            # Start PM2 directly like wishhub (no ecosystem.config.js needed)
            if pm2 describe xcited-web >/dev/null 2>&1; then
              echo "   Restarting existing process..."
              pm2 restart xcited-web --update-env
            else
              echo "   Starting new process..."
              pm2 start "$SERVER_JS" --name xcited-web
            fi
            
            pm2 save
            echo "âœ… Application started with PM2"
            
            # Verify application is running
            echo "ðŸ” Verifying application..."
            sleep 3
            if pm2 describe xcited-web >/dev/null 2>&1; then
              echo "âœ… PM2 process xcited-web is running"
              pm2 list
            else
              echo "âš ï¸  PM2 process xcited-web not found"
              pm2 list
            fi
            
            # Test if application responds on port 3001
            echo "ðŸ” Testing application on port 3001..."
            if curl -f http://localhost:3001 >/dev/null 2>&1; then
              echo "âœ… Application responds on port 3001"
            else
              echo "âš ï¸  Application does not respond on port 3001"
              echo "   Checking PM2 logs..."
              pm2 logs xcited-web --lines 20 --nostream || echo "   No logs available"
            fi
            
            # Final permissions check for Apache
            echo "ðŸ” Final permissions check for Apache..."
            echo "   Target directory:"
            ls -ld "${TARGET}"
            echo "   Sample files:"
            ls -la "${TARGET}" | head -15
            echo "   Owner: $(stat -c '%U:%G' "${TARGET}" 2>/dev/null || echo 'unknown')"
            echo "   Permissions: $(stat -c '%a' "${TARGET}" 2>/dev/null || echo 'unknown')"
            
            # Check if Apache can access (if running as apache user)
            if id apache >/dev/null 2>&1; then
              echo "   Apache user exists, checking access..."
              # Apache should be able to read files with 644 and directories with 755
              if [ -r "${TARGET}" ]; then
                echo "   âœ… Apache can read target directory"
              else
                echo "   âš ï¸  WARN: Apache may not be able to read target directory"
              fi
            fi
            
            # Check SELinux context (if applicable)
            if command -v getenforce >/dev/null 2>&1; then
              SELINUX_STATUS=$(getenforce 2>/dev/null || echo "Disabled")
              echo "   SELinux status: ${SELINUX_STATUS}"
              if [ "${SELINUX_STATUS}" != "Disabled" ]; then
                echo "   âš ï¸  WARN: SELinux is enabled - fixing context..."
                sudo chcon -R -t httpd_sys_content_t "${TARGET}" 2>/dev/null || echo "   âš ï¸  SELinux context fix failed"
              fi
            fi
            
            # Final PM2 status and logs
            echo ""
            echo "ðŸ” Final PM2 Status:"
            pm2 list
            echo ""
            echo "ðŸ” PM2 Process Info:"
            pm2 describe xcited-web 2>/dev/null || echo "   âš ï¸  Process not found"
            echo ""
            echo "ðŸ” Last 30 lines of PM2 error log:"
            pm2 logs xcited-web --lines 30 --nostream --err 2>/dev/null || echo "   No error logs"
            echo ""
            echo "ðŸ” Last 30 lines of PM2 output log:"
            pm2 logs xcited-web --lines 30 --nostream --out 2>/dev/null || echo "   No output logs"
            echo ""
            echo "ðŸ” Testing application on port 3001:"
            if curl -f -s http://localhost:3001 >/dev/null 2>&1; then
              echo "   âœ… Application responds on port 3001"
              curl -I http://localhost:3001 2>/dev/null | head -5
            else
              echo "   âŒ Application does NOT respond on port 3001"
              echo "   Checking if port is listening:"
              netstat -tulpn | grep 3001 || ss -tulpn | grep 3001 || echo "   Port 3001 is not listening"
            fi
            echo ""
            echo "ðŸ” Apache error logs (last 20 lines):"
            tail -20 /var/log/httpd/xcited_error.log 2>/dev/null || echo "   No Apache error logs found"

