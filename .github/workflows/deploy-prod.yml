name: Deploy xcited to Production

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/TRIGGER_DEPLOY'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate || echo "âš ï¸  Prisma generate failed (continuing without DB)"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://user:pass@localhost:5432/xcited' }}

      - name: Build Next.js app
        run: npm run build
        env:
          NODE_ENV: production
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://user:pass@localhost:5432/xcited' }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET || 'xcited-temp-secret-key-min-32-chars-long-for-build' }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL || 'https://xcited.ro' }}

      - name: Create deployment package
        run: |
          rm -rf deploy-package
          mkdir -p deploy-package
          
          # Next.js standalone output (like 1dream)
          if [ -d ".next/standalone" ]; then
            echo "âœ… Found standalone build"
            cp -R .next/standalone/* deploy-package/
            
            # Static assets must be copied into the standalone folder structure
            mkdir -p deploy-package/.next
            cp -R .next/static deploy-package/.next/static
            
            # public/ is optional in Next.js projects
            if [ -d "public" ]; then
              cp -R public deploy-package/public
            fi
          else
            echo "âš ï¸  No standalone build, using regular build"
            cp -r .next deploy-package/
            if [ -d "public" ]; then
              cp -r public deploy-package/
            fi
          fi
          
          # Copy necessary files
          if [ -d "prisma" ]; then
            cp -r prisma deploy-package/
          fi
          cp package.json deploy-package/
          cp package-lock.json deploy-package/ 2>/dev/null || true
          cp next.config.ts deploy-package/
          cp tsconfig.json deploy-package/
          
          # Copy Prisma generated client
          if [ -d "node_modules/.prisma" ]; then
            mkdir -p deploy-package/node_modules
            cp -r node_modules/.prisma deploy-package/node_modules/ 2>/dev/null || true
          fi
          
          # Create ecosystem.config.js for PM2 (like 1dream - using echo to avoid YAML issues)
          echo 'module.exports = {' > deploy-package/ecosystem.config.js
          echo '  apps: [{' >> deploy-package/ecosystem.config.js
          echo "    name: 'xcited-web'," >> deploy-package/ecosystem.config.js
          echo "    script: 'server.js'," >> deploy-package/ecosystem.config.js
          echo "    cwd: '/home/xcited/public_html'," >> deploy-package/ecosystem.config.js
          echo '    instances: 2,' >> deploy-package/ecosystem.config.js
          echo "    exec_mode: 'cluster'," >> deploy-package/ecosystem.config.js
          echo '    env: {' >> deploy-package/ecosystem.config.js
          echo "      NODE_ENV: 'production'," >> deploy-package/ecosystem.config.js
          echo '      PORT: 3001' >> deploy-package/ecosystem.config.js
          echo '    },' >> deploy-package/ecosystem.config.js
          echo "    error_file: '/var/log/pm2/xcited-web-error.log'," >> deploy-package/ecosystem.config.js
          echo "    out_file: '/var/log/pm2/xcited-web-out.log'," >> deploy-package/ecosystem.config.js
          echo "    log_date_format: 'YYYY-MM-DD HH:mm:ss Z'," >> deploy-package/ecosystem.config.js
          echo '    merge_logs: true,' >> deploy-package/ecosystem.config.js
          echo '    autorestart: true,' >> deploy-package/ecosystem.config.js
          echo "    max_memory_restart: '1G'" >> deploy-package/ecosystem.config.js
          echo '  }]' >> deploy-package/ecosystem.config.js
          echo '}' >> deploy-package/ecosystem.config.js

      - name: Deploy to CWP7pro Production
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.CWP_HOST }}
          username: ${{ secrets.CWP_USER }}
          password: ${{ secrets.CWP_SSH_KEY }}
          port: ${{ secrets.CWP_PORT || 22 }}
          source: "deploy-package/*"
          target: "/home/xcited/public_html"
          rm: true

      - name: Run post-deploy script on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.CWP_HOST }}
          username: ${{ secrets.CWP_USER }}
          password: ${{ secrets.CWP_SSH_KEY }}
          port: ${{ secrets.CWP_PORT || 22 }}
          script: |
            set -e
            
            TARGET="/home/xcited/public_html"
            OWNER_USER="xcited"
            OWNER_GROUP="xcited"
            
            # Get current user (should be root)
            REMOTE_USER="$(id -un)"
            REMOTE_GROUP="$(id -gn)"
            
            echo "== Remote identity =="
            whoami
            id
            
            # Verify xcited user exists (should exist since domain exists)
            if ! id -u "${OWNER_USER}" >/dev/null 2>&1; then
              echo "âš ï¸  ERROR: user '${OWNER_USER}' does not exist!"
              echo "   User should exist since domain xcited.ro exists in CWP7pro"
              echo "   Please verify user exists or create it manually"
              exit 1
            fi
            if ! getent group "${OWNER_GROUP}" >/dev/null 2>&1; then
              echo "âš ï¸  WARN: group '${OWNER_GROUP}' does not exist. Creating group..."
              groupadd "${OWNER_GROUP}" 2>/dev/null || {
                echo "   Group creation failed, using existing group for user"
                OWNER_GROUP=$(id -gn "${OWNER_USER}")
              }
            fi
            
            echo "== Ensure target directory exists =="
            mkdir -p "${TARGET}"
            
            echo "== Set correct ownership and permissions =="
            # Set ownership to xcited user (or fallback)
            # Use sudo to ensure ownership change works even if files are owned by root
            if sudo -n true 2>/dev/null; then
              sudo chown -R "${OWNER_USER}:${OWNER_GROUP}" "${TARGET}" || {
                echo "WARN: sudo chown failed, trying without sudo..."
                chown -R "${OWNER_USER}:${OWNER_GROUP}" "${TARGET}" || echo "âš ï¸  Ownership change failed"
              }
            else
              chown -R "${OWNER_USER}:${OWNER_GROUP}" "${TARGET}" || {
                echo "WARN: chown failed (may need sudo)"
                echo "âš ï¸  Ownership change failed - files may still be owned by root"
              }
            fi
            
            # Set correct permissions for directories and files
            find "${TARGET}" -type d -exec chmod 755 {} \; 2>/dev/null || {
              echo "WARN: chmod directories failed, trying with sudo..."
              sudo find "${TARGET}" -type d -exec chmod 755 {} \; || echo "âš ï¸  Directory permissions failed"
            }
            
            find "${TARGET}" -type f -exec chmod 644 {} \; 2>/dev/null || {
              echo "WARN: chmod files failed, trying with sudo..."
              sudo find "${TARGET}" -type f -exec chmod 644 {} \; || echo "âš ï¸  File permissions failed"
            }
            
            # Ensure user has read/write/execute on directories
            chmod -R u+rwX "${TARGET}" 2>/dev/null || {
              echo "WARN: chmod u+rwX failed, trying with sudo..."
              sudo chmod -R u+rwX "${TARGET}" || echo "âš ï¸  User permissions failed"
            }
            
            echo "âœ… Permissions set correctly"
            echo "   Owner: ${OWNER_USER}:${OWNER_GROUP}"
            echo "   Target: ${TARGET}"
            
            cd "${TARGET}"
            
            echo "âœ… Files deployed"
            
            # Install dependencies (for standalone build, minimal install needed)
            if [ -f "package.json" ]; then
              npm install --production || npm ci --production --frozen-lockfile || echo "âš ï¸  npm install failed (continuing...)"
            fi
            
            # Prisma setup
            if [ -d "prisma" ]; then
              npx prisma generate || echo "âš ï¸  Prisma generate failed (continuing...)"
              if [ -n "${{ secrets.DATABASE_URL }}" ] && [ "${{ secrets.DATABASE_URL }}" != "postgresql://user:pass@localhost:5432/xcited" ]; then
                DATABASE_URL="${{ secrets.DATABASE_URL }}" npx prisma migrate deploy || echo "âš ï¸  Migrations failed (continuing...)"
              fi
            fi
            
            # PM2 management
            echo "ðŸ”„ Managing PM2 process..."
            pm2 delete xcited-web 2>/dev/null || true
            
            # Find server.js in standalone build structure (exclude node_modules)
            SERVER_JS=""
            if [ -f "server.js" ]; then
              SERVER_JS="server.js"
            elif [ -f ".next/standalone/server.js" ]; then
              SERVER_JS=".next/standalone/server.js"
            elif [ -f "standalone/server.js" ]; then
              SERVER_JS="standalone/server.js"
            else
              echo "ðŸ” Searching for server.js (excluding node_modules)..."
              SERVER_JS=$(find . -name "server.js" -type f -not -path "*/node_modules/*" | head -1)
            fi
            
            if [ -z "$SERVER_JS" ] || [ ! -f "$SERVER_JS" ]; then
              echo "âš ï¸  server.js not found"
              echo "ðŸ“ Current directory structure:"
              ls -la
              echo ""
              echo "ðŸ” Searching for server.js (excluding node_modules)..."
              find . -name "server.js" -type f -not -path "*/node_modules/*" || echo "No server.js found"
              echo ""
              echo "âš ï¸  Cannot start PM2 without server.js"
              echo "ðŸ’¡ VerificÄƒ dacÄƒ build-ul standalone a fost creat corect"
              exit 1
            fi
            
            echo "âœ… Found server.js at: $SERVER_JS"
            
            # Update ecosystem.config.js with correct server.js path
            if [ -f "ecosystem.config.js" ]; then
              # Update script path in ecosystem.config.js
              sed -i "s|script: 'server.js'|script: '$SERVER_JS'|g" ecosystem.config.js || true
              # Update cwd to current directory
              sed -i "s|cwd: '/home/xcited/public_html'|cwd: '$(pwd)'|g" ecosystem.config.js || true
              echo "ðŸ“‹ Starting PM2 with ecosystem.config.js..."
              pm2 start ecosystem.config.js
            else
              # Create ecosystem.config.js if it doesn't exist
              echo "ðŸ“ Creating ecosystem.config.js..."
              echo 'module.exports = {' > ecosystem.config.js
              echo '  apps: [{' >> ecosystem.config.js
              echo "    name: 'xcited-web'," >> ecosystem.config.js
              echo "    script: '$SERVER_JS'," >> ecosystem.config.js
              echo "    cwd: '$(pwd)'," >> ecosystem.config.js
              echo '    instances: 2,' >> ecosystem.config.js
              echo "    exec_mode: 'cluster'," >> ecosystem.config.js
              echo '    env: {' >> ecosystem.config.js
              echo "      NODE_ENV: 'production'," >> ecosystem.config.js
              echo '      PORT: 3001' >> ecosystem.config.js
              echo '    },' >> ecosystem.config.js
              echo "    error_file: '/var/log/pm2/xcited-web-error.log'," >> ecosystem.config.js
              echo "    out_file: '/var/log/pm2/xcited-web-out.log'," >> ecosystem.config.js
              echo "    log_date_format: 'YYYY-MM-DD HH:mm:ss Z'," >> ecosystem.config.js
              echo '    merge_logs: true,' >> ecosystem.config.js
              echo '    autorestart: true,' >> ecosystem.config.js
              echo "    max_memory_restart: '1G'" >> ecosystem.config.js
              echo '  }]' >> ecosystem.config.js
              echo '}' >> ecosystem.config.js
              pm2 start ecosystem.config.js
            fi
            
            pm2 save
            echo "âœ… Application started with PM2"
            
            # Verify application is running
            echo "ðŸ” Verifying application..."
            sleep 3
            if pm2 describe xcited-web >/dev/null 2>&1; then
              echo "âœ… PM2 process xcited-web is running"
              pm2 list
            else
              echo "âš ï¸  PM2 process xcited-web not found"
              pm2 list
            fi
            
            # Test if application responds on port 3001
            echo "ðŸ” Testing application on port 3001..."
            if curl -f http://localhost:3001 >/dev/null 2>&1; then
              echo "âœ… Application responds on port 3001"
            else
              echo "âš ï¸  Application does not respond on port 3001"
              echo "   Checking PM2 logs..."
              pm2 logs xcited-web --lines 20 --nostream || echo "   No logs available"
            fi
            
            # Final permissions check for Apache
            echo "ðŸ” Final permissions check..."
            ls -la "${TARGET}" | head -10
            echo "   Owner: $(stat -c '%U:%G' "${TARGET}" 2>/dev/null || echo 'unknown')"
            echo "   Permissions: $(stat -c '%a' "${TARGET}" 2>/dev/null || echo 'unknown')"

