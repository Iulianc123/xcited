name: Deploy xcited to Production

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/TRIGGER_DEPLOY'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate || echo "‚ö†Ô∏è  Prisma generate failed (continuing without DB)"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://user:pass@localhost:5432/xcited' }}

      - name: Build Next.js app
        run: npm run build
        env:
          NODE_ENV: production
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://user:pass@localhost:5432/xcited' }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET || 'xcited-temp-secret-key-min-32-chars-long-for-build' }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL || 'https://xcited.ro' }}

      - name: Create deployment package
        run: |
          rm -rf deploy-package
          mkdir -p deploy-package
          
          # Next.js standalone output (like 1dream)
          if [ -d ".next/standalone" ]; then
            echo "‚úÖ Found standalone build"
            cp -R .next/standalone/* deploy-package/
            
            # Static assets must be copied into the standalone folder structure
            mkdir -p deploy-package/.next
            cp -R .next/static deploy-package/.next/static
            
            # public/ is optional in Next.js projects
            if [ -d "public" ]; then
              cp -R public deploy-package/public
            fi
          else
            echo "‚ö†Ô∏è  No standalone build, using regular build"
            cp -r .next deploy-package/
            if [ -d "public" ]; then
              cp -r public deploy-package/
            fi
          fi
          
          # Copy necessary files
          if [ -d "prisma" ]; then
            cp -r prisma deploy-package/
          fi
          cp package.json deploy-package/
          cp package-lock.json deploy-package/ 2>/dev/null || true
          cp next.config.ts deploy-package/
          cp tsconfig.json deploy-package/
          
          # Copy Prisma generated client
          if [ -d "node_modules/.prisma" ]; then
            mkdir -p deploy-package/node_modules
            cp -r node_modules/.prisma deploy-package/node_modules/ 2>/dev/null || true
          fi
          
          # Create ecosystem.config.js for PM2 (like 1dream - using echo to avoid YAML issues)
          echo 'module.exports = {' > deploy-package/ecosystem.config.js
          echo '  apps: [{' >> deploy-package/ecosystem.config.js
          echo "    name: 'xcited-web'," >> deploy-package/ecosystem.config.js
          echo "    script: 'server.js'," >> deploy-package/ecosystem.config.js
          echo "    cwd: '/home/xcited/public_html'," >> deploy-package/ecosystem.config.js
          echo '    instances: 2,' >> deploy-package/ecosystem.config.js
          echo "    exec_mode: 'cluster'," >> deploy-package/ecosystem.config.js
          echo '    env: {' >> deploy-package/ecosystem.config.js
          echo "      NODE_ENV: 'production'," >> deploy-package/ecosystem.config.js
          echo '      PORT: 3001' >> deploy-package/ecosystem.config.js
          echo '    },' >> deploy-package/ecosystem.config.js
          echo "    error_file: '/var/log/pm2/xcited-web-error.log'," >> deploy-package/ecosystem.config.js
          echo "    out_file: '/var/log/pm2/xcited-web-out.log'," >> deploy-package/ecosystem.config.js
          echo "    log_date_format: 'YYYY-MM-DD HH:mm:ss Z'," >> deploy-package/ecosystem.config.js
          echo '    merge_logs: true,' >> deploy-package/ecosystem.config.js
          echo '    autorestart: true,' >> deploy-package/ecosystem.config.js
          echo "    max_memory_restart: '1G'" >> deploy-package/ecosystem.config.js
          echo '  }]' >> deploy-package/ecosystem.config.js
          echo '}' >> deploy-package/ecosystem.config.js

      - name: Deploy to CWP7pro Production
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.CWP_HOST }}
          username: ${{ secrets.CWP_USER }}
          password: ${{ secrets.CWP_SSH_KEY }}
          port: ${{ secrets.CWP_PORT || 22 }}
          source: "deploy-package/*"
          target: "/home/xcited/public_html"
          rm: true

      - name: Run post-deploy script on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.CWP_HOST }}
          username: ${{ secrets.CWP_USER }}
          password: ${{ secrets.CWP_SSH_KEY }}
          port: ${{ secrets.CWP_PORT || 22 }}
          script: |
            set -e
            cd /home/xcited/public_html
            
            # Ensure directory exists and has correct permissions
            mkdir -p /home/xcited/public_html
            chown -R xcited:xcited /home/xcited/public_html 2>/dev/null || true
            
            echo "‚úÖ Files deployed"
            
            # Install dependencies (for standalone build, minimal install needed)
            if [ -f "package.json" ]; then
              npm install --production || npm ci --production --frozen-lockfile || echo "‚ö†Ô∏è  npm install failed (continuing...)"
            fi
            
            # Prisma setup
            if [ -d "prisma" ]; then
              npx prisma generate || echo "‚ö†Ô∏è  Prisma generate failed (continuing...)"
              if [ -n "${{ secrets.DATABASE_URL }}" ] && [ "${{ secrets.DATABASE_URL }}" != "postgresql://user:pass@localhost:5432/xcited" ]; then
                DATABASE_URL="${{ secrets.DATABASE_URL }}" npx prisma migrate deploy || echo "‚ö†Ô∏è  Migrations failed (continuing...)"
              fi
            fi
            
            # PM2 management
            echo "üîÑ Managing PM2 process..."
            pm2 delete xcited-web 2>/dev/null || true
            
            # Find server.js in standalone build structure (exclude node_modules)
            SERVER_JS=""
            if [ -f "server.js" ]; then
              SERVER_JS="server.js"
            elif [ -f ".next/standalone/server.js" ]; then
              SERVER_JS=".next/standalone/server.js"
            elif [ -f "standalone/server.js" ]; then
              SERVER_JS="standalone/server.js"
            else
              echo "üîç Searching for server.js (excluding node_modules)..."
              SERVER_JS=$(find . -name "server.js" -type f -not -path "*/node_modules/*" | head -1)
            fi
            
            if [ -z "$SERVER_JS" ] || [ ! -f "$SERVER_JS" ]; then
              echo "‚ö†Ô∏è  server.js not found"
              echo "üìÅ Current directory structure:"
              ls -la
              echo ""
              echo "üîç Searching for server.js (excluding node_modules)..."
              find . -name "server.js" -type f -not -path "*/node_modules/*" || echo "No server.js found"
              echo ""
              echo "‚ö†Ô∏è  Cannot start PM2 without server.js"
              echo "üí° VerificƒÉ dacƒÉ build-ul standalone a fost creat corect"
              exit 1
            fi
            
            echo "‚úÖ Found server.js at: $SERVER_JS"
            
            # Update ecosystem.config.js with correct server.js path
            if [ -f "ecosystem.config.js" ]; then
              # Update script path in ecosystem.config.js
              sed -i "s|script: 'server.js'|script: '$SERVER_JS'|g" ecosystem.config.js || true
              pm2 start ecosystem.config.js
            else
              # Start directly with server.js (use --exec_mode with underscore, not --exec-mode)
              pm2 start "$SERVER_JS" --name "xcited-web" --instances 2 --exec_mode cluster --env PORT=3001
            fi
            
            pm2 save
            echo "‚úÖ Application started with PM2"

