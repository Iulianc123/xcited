name: Deploy xcited to Production

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://placeholder' }}

      - name: Build Next.js app
        run: npm run build
        env:
          NODE_ENV: production
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://placeholder' }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET || 'placeholder-secret-min-32-chars-long' }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL || 'https://xcited.ro' }}

      - name: Create deployment package
        run: |
          mkdir -p deploy-package
          # Copy standalone build
          if [ -d ".next/standalone" ]; then
            echo "‚úÖ Found standalone build, copying..."
            cp -r .next/standalone/* deploy-package/
            mkdir -p deploy-package/.next
            cp -r .next/static deploy-package/.next/static
            cp -r public deploy-package/public
            echo "‚úÖ Standalone build copied"
          else
            echo "‚ö†Ô∏è  No standalone build found, using regular build..."
            # Fallback: copy regular build
            cp -r .next deploy-package/
            cp -r public deploy-package/
            echo "‚úÖ Regular build copied"
          fi
          # Copy necessary files
          cp -r prisma deploy-package/
          cp package.json deploy-package/
          cp package-lock.json deploy-package/ 2>/dev/null || true
          cp next.config.ts deploy-package/
          cp tsconfig.json deploy-package/
          # Copy Prisma generated client
          cp -r node_modules/.prisma deploy-package/node_modules/ 2>/dev/null || true
          # Create ecosystem.config.js for PM2
          cat > deploy-package/ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'xcited-web',
    script: 'server.js',
    cwd: '/home/xcited/public_html',
    instances: 2,
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3001
    },
    error_file: '/var/log/pm2/xcited-web-error.log',
    out_file: '/var/log/pm2/xcited-web-out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    merge_logs: true,
    autorestart: true,
    max_memory_restart: '1G'
  }]
}
EOF

      - name: Deploy to CWP7pro Production
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.CWP_PROD_HOST }}
          username: ${{ secrets.CWP_PROD_USER }}
          key: ${{ secrets.CWP_PROD_SSH_KEY }}
          port: ${{ secrets.CWP_PROD_PORT || 22 }}
          source: "deploy-package/*"
          target: "/home/xcited/public_html"
          rm: true

      - name: Run post-deploy on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.CWP_PROD_HOST }}
          username: ${{ secrets.CWP_PROD_USER }}
          key: ${{ secrets.CWP_PROD_SSH_KEY }}
          port: ${{ secrets.CWP_PROD_PORT || 22 }}
          script: |
            set -e
            echo "üîç Checking if /home/xcited/public_html exists..."
            if [ ! -d "/home/xcited/public_html" ]; then
              echo "üìÅ Creating directory /home/xcited/public_html..."
              mkdir -p /home/xcited/public_html
              chown -R xcited:xcited /home/xcited/public_html 2>/dev/null || chown -R root:root /home/xcited/public_html || echo "‚ö†Ô∏è  Could not change ownership, continuing..."
            fi
            
            cd /home/xcited/public_html || {
              echo "‚ùå ERROR: Cannot cd to /home/xcited/public_html"
              exit 1
            }
            echo "üìÇ Current directory: $(pwd)"
            echo "üìã Files:"
            ls -la || echo "‚ö†Ô∏è  ls failed, directory might be empty"
            
            echo "üì¶ Installing production dependencies..."
            if [ -f "package-lock.json" ]; then
              npm ci --production --frozen-lockfile || {
                echo "‚ö†Ô∏è  npm ci failed, trying npm install..."
                npm install --production || {
                  echo "‚ùå npm install failed"
                  exit 1
                }
              }
            else
              npm install --production || {
                echo "‚ùå npm install failed"
                exit 1
              }
            fi
            echo "‚úÖ Dependencies installed"
            
            echo "üîß Generating Prisma Client..."
            if [ -d "prisma" ]; then
              npx prisma generate || echo "‚ö†Ô∏è  Prisma generate failed (continuing...)"
            fi
            
            echo "üîÑ Running Prisma migrations..."
            if [ -d "prisma" ] && [ -n "${{ secrets.DATABASE_URL }}" ]; then
              DATABASE_URL="${{ secrets.DATABASE_URL }}" npx prisma migrate deploy || echo "‚ö†Ô∏è  Migrations failed (continuing...)"
            fi
            
            echo "üîÑ Restarting application with PM2..."
            # Stop existing process
            pm2 delete xcited-web 2>/dev/null || echo "‚ö†Ô∏è  No existing process to delete"
            
            # Check what files we have
            echo "üìã Checking files..."
            ls -la server.js ecosystem.config.js 2>/dev/null || echo "‚ö†Ô∏è  Some files not found"
            
            # Start with ecosystem.config.js if it exists, otherwise use server.js
            if [ -f "ecosystem.config.js" ]; then
              echo "‚úÖ Starting with ecosystem.config.js..."
              pm2 start ecosystem.config.js || {
                echo "‚ö†Ô∏è  Failed to start with ecosystem.config.js, trying server.js directly..."
                if [ -f "server.js" ]; then
                  echo "‚úÖ Starting with server.js..."
                  pm2 start server.js --name "xcited-web" --instances 2 --exec-mode cluster --env PORT=3001 || {
                    echo "‚ùå Failed to start server.js"
                    pm2 list
                    exit 1
                  }
                else
                  echo "‚ùå ERROR: No server.js found!"
                  echo "üìã Files in directory:"
                  ls -la
                  exit 1
                fi
              }
            elif [ -f "server.js" ]; then
              echo "‚úÖ Starting with server.js..."
              pm2 start server.js --name "xcited-web" --instances 2 --exec-mode cluster --env PORT=3001 || {
                echo "‚ùå Failed to start server.js"
                pm2 list
                exit 1
              }
            else
              echo "‚ùå ERROR: No server.js or ecosystem.config.js found!"
              echo "üìã Files in directory:"
              ls -la
              exit 1
            fi
            
            pm2 save || echo "‚ö†Ô∏è  pm2 save failed"
            echo "üìä PM2 processes:"
            pm2 list
            
            echo "‚úÖ Deployment completed successfully!"

