name: Deploy xcited to Production

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/TRIGGER_DEPLOY'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate || echo "‚ö†Ô∏è  Prisma generate failed (continuing without DB)"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://user:pass@localhost:5432/xcited' }}

      - name: Build Next.js app
        run: npm run build
        env:
          NODE_ENV: production
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://user:pass@localhost:5432/xcited' }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET || 'xcited-temp-secret-key-min-32-chars-long-for-build' }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL || 'https://xcited.ro' }}

      - name: Create deployment package
        run: |
          rm -rf deploy-package
          mkdir -p deploy-package
          
          # Next.js standalone output (like 1dream)
          if [ -d ".next/standalone" ]; then
            echo "‚úÖ Found standalone build"
            cp -R .next/standalone/* deploy-package/
            
            # Static assets must be copied into the standalone folder structure
            mkdir -p deploy-package/.next
            cp -R .next/static deploy-package/.next/static
            
            # public/ is optional in Next.js projects
            if [ -d "public" ]; then
              cp -R public deploy-package/public
            fi
          else
            echo "‚ö†Ô∏è  No standalone build, using regular build"
            cp -r .next deploy-package/
            if [ -d "public" ]; then
              cp -r public deploy-package/
            fi
          fi
          
          # Copy necessary files
          if [ -d "prisma" ]; then
            cp -r prisma deploy-package/
          fi
          cp package.json deploy-package/
          cp package-lock.json deploy-package/ 2>/dev/null || true
          cp next.config.ts deploy-package/
          cp tsconfig.json deploy-package/
          
          # Copy Prisma generated client
          if [ -d "node_modules/.prisma" ]; then
            mkdir -p deploy-package/node_modules
            cp -r node_modules/.prisma deploy-package/node_modules/ 2>/dev/null || true
          fi
          
          # Create ecosystem.config.js for PM2 (like 1dream - using echo to avoid YAML issues)
          echo 'module.exports = {' > deploy-package/ecosystem.config.js
          echo '  apps: [{' >> deploy-package/ecosystem.config.js
          echo "    name: 'xcited-web'," >> deploy-package/ecosystem.config.js
          echo "    script: 'server.js'," >> deploy-package/ecosystem.config.js
          echo "    cwd: '/home/xcited/public_html'," >> deploy-package/ecosystem.config.js
          echo '    instances: 2,' >> deploy-package/ecosystem.config.js
          echo "    exec_mode: 'cluster'," >> deploy-package/ecosystem.config.js
          echo '    env: {' >> deploy-package/ecosystem.config.js
          echo "      NODE_ENV: 'production'," >> deploy-package/ecosystem.config.js
          echo '      PORT: 3001' >> deploy-package/ecosystem.config.js
          echo '    },' >> deploy-package/ecosystem.config.js
          echo "    error_file: '/var/log/pm2/xcited-web-error.log'," >> deploy-package/ecosystem.config.js
          echo "    out_file: '/var/log/pm2/xcited-web-out.log'," >> deploy-package/ecosystem.config.js
          echo "    log_date_format: 'YYYY-MM-DD HH:mm:ss Z'," >> deploy-package/ecosystem.config.js
          echo '    merge_logs: true,' >> deploy-package/ecosystem.config.js
          echo '    autorestart: true,' >> deploy-package/ecosystem.config.js
          echo "    max_memory_restart: '1G'" >> deploy-package/ecosystem.config.js
          echo '  }]' >> deploy-package/ecosystem.config.js
          echo '}' >> deploy-package/ecosystem.config.js

      - name: Pre-deploy: Ensure directory permissions
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.CWP_HOST }}
          username: ${{ secrets.CWP_USER }}
          password: ${{ secrets.CWP_SSH_KEY }}
          port: ${{ secrets.CWP_PORT || 22 }}
          script: |
            set -e
            TARGET="/home/xcited/public_html"
            OWNER_USER="xcited"
            OWNER_GROUP="xcited"
            
            echo "== Pre-deploy: Ensure directory is ready =="
            
            # Verify user exists
            if ! id -u "${OWNER_USER}" >/dev/null 2>&1; then
              echo "‚ö†Ô∏è  ERROR: user '${OWNER_USER}' does not exist!"
              exit 1
            fi
            
            # Ensure target directory exists and has correct ownership
            mkdir -p "${TARGET}"
            
            # Set ownership BEFORE SCP (critical!)
            echo "üîß Setting ownership BEFORE SCP..."
            if sudo -n true 2>/dev/null; then
              sudo -n chown -R "${OWNER_USER}:${OWNER_GROUP}" "${TARGET}" || true
              sudo -n chmod -R u+rwX "${TARGET}" || true
            else
              chown -R "${OWNER_USER}:${OWNER_GROUP}" "${TARGET}" || true
              chmod -R u+rwX "${TARGET}" || true
            fi
            
            # Verify writable
            if ! ( touch "${TARGET}/.gha_write_test" && rm -f "${TARGET}/.gha_write_test" ); then
              echo "‚ö†Ô∏è  WARN: ${TARGET} is not writable"
              if sudo -n true 2>/dev/null; then
                sudo -n chown -R "${OWNER_USER}:${OWNER_GROUP}" "${TARGET}" || true
                sudo -n chmod -R u+rwX "${TARGET}" || true
              fi
            fi
            
            echo "‚úÖ Directory ready for SCP"

      - name: Deploy to CWP7pro Production
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.CWP_HOST }}
          username: ${{ secrets.CWP_USER }}
          password: ${{ secrets.CWP_SSH_KEY }}
          port: ${{ secrets.CWP_PORT || 22 }}
          source: "deploy-package/*"
          target: "/home/xcited/public_html"
          rm: true

      - name: Run post-deploy script on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.CWP_HOST }}
          username: ${{ secrets.CWP_USER }}
          password: ${{ secrets.CWP_SSH_KEY }}
          port: ${{ secrets.CWP_PORT || 22 }}
          script: |
            set -e
            # Note: This script runs as the user specified in CWP_USER (usually root)
            # We use sudo where needed, but most commands should work as root
            
            TARGET="/home/xcited/public_html"
            OWNER_USER="xcited"
            OWNER_GROUP="xcited"
            
            # Get current user (should be root)
            REMOTE_USER="$(id -un)"
            REMOTE_GROUP="$(id -gn)"
            
            echo "== Remote identity =="
            whoami
            id
            
            # Verify xcited user exists (should exist since domain exists)
            if ! id -u "${OWNER_USER}" >/dev/null 2>&1; then
              echo "‚ö†Ô∏è  ERROR: user '${OWNER_USER}' does not exist!"
              echo "   User should exist since domain xcited.ro exists in CWP7pro"
              echo "   Please verify user exists or create it manually"
              exit 1
            fi
            if ! getent group "${OWNER_GROUP}" >/dev/null 2>&1; then
              echo "‚ö†Ô∏è  WARN: group '${OWNER_GROUP}' does not exist. Creating group..."
              groupadd "${OWNER_GROUP}" 2>/dev/null || {
                echo "   Group creation failed, using existing group for user"
                OWNER_GROUP=$(id -gn "${OWNER_USER}")
              }
            fi
            
            echo "== Ensure target directory exists =="
            mkdir -p "${TARGET}"
            
            echo "== Set correct ownership and permissions (POST-SCP) =="
            # CRITICAL: SCP may copy files as root, so we MUST fix ownership after SCP
            # Use sudo -n (non-interactive) to ensure it works even if we're already root
            echo "üîß Setting ownership to ${OWNER_USER}:${OWNER_GROUP}..."
            
            # Use sudo -n (non-interactive) like 1dream does
            if sudo -n true 2>/dev/null; then
              echo "   Using sudo -n (non-interactive)..."
              sudo -n chown -R "${OWNER_USER}:${OWNER_GROUP}" "${TARGET}" || {
                echo "‚ö†Ô∏è  sudo -n chown failed, trying without -n..."
                sudo chown -R "${OWNER_USER}:${OWNER_GROUP}" "${TARGET}" || {
                  echo "‚ùå Ownership change failed"
                  exit 1
                }
              }
            else
              # If we're already root, chown should work directly
              chown -R "${OWNER_USER}:${OWNER_GROUP}" "${TARGET}" || {
                echo "‚ùå Ownership change failed (not root and no sudo)"
                exit 1
              }
            fi
            
            # Verify ownership was set correctly
            echo "üîç Verifying ownership..."
            WRONG_OWNER=$(find "${TARGET}" ! -user "${OWNER_USER}" -o ! -group "${OWNER_GROUP}" 2>/dev/null | head -10)
            if [ -n "$WRONG_OWNER" ]; then
              echo "‚ö†Ô∏è  WARNING: Some files still have wrong ownership:"
              echo "$WRONG_OWNER"
              echo "   Attempting aggressive fix..."
              if sudo -n true 2>/dev/null; then
                sudo -n find "${TARGET}" ! -user "${OWNER_USER}" -exec chown "${OWNER_USER}:${OWNER_GROUP}" {} \; 2>/dev/null || true
                sudo -n find "${TARGET}" ! -group "${OWNER_GROUP}" -exec chgrp "${OWNER_GROUP}" {} \; 2>/dev/null || true
              fi
            else
              echo "‚úÖ All files have correct ownership: ${OWNER_USER}:${OWNER_GROUP}"
            fi
            
            # Set correct permissions for directories and files (like 1dream)
            echo "üîß Setting permissions..."
            if sudo -n true 2>/dev/null; then
              sudo -n find "${TARGET}" -type d -exec chmod 755 {} \; || true
              sudo -n find "${TARGET}" -type f -exec chmod 644 {} \; || true
              sudo -n chmod -R u+rwX "${TARGET}" || true
            else
              find "${TARGET}" -type d -exec chmod 755 {} \; || true
              find "${TARGET}" -type f -exec chmod 644 {} \; || true
              chmod -R u+rwX "${TARGET}" || true
            fi
            
            # Final verification
            echo "üîç Final ownership verification..."
            ls -ld "${TARGET}"
            ls -la "${TARGET}" | head -10
            echo "   Owner: $(stat -c '%U:%G' "${TARGET}" 2>/dev/null || echo 'unknown')"
            echo "   Permissions: $(stat -c '%a' "${TARGET}" 2>/dev/null || echo 'unknown')"
            
            echo "‚úÖ Permissions set correctly"
            echo "   Owner: ${OWNER_USER}:${OWNER_GROUP}"
            echo "   Target: ${TARGET}"
            
            cd "${TARGET}"
            
            echo "‚úÖ Files deployed"
            
            # Install dependencies (for standalone build, minimal install needed)
            if [ -f "package.json" ]; then
              npm install --production || npm ci --production --frozen-lockfile || echo "‚ö†Ô∏è  npm install failed (continuing...)"
            fi
            
            # Prisma setup
            if [ -d "prisma" ]; then
              npx prisma generate || echo "‚ö†Ô∏è  Prisma generate failed (continuing...)"
              if [ -n "${{ secrets.DATABASE_URL }}" ] && [ "${{ secrets.DATABASE_URL }}" != "postgresql://user:pass@localhost:5432/xcited" ]; then
                DATABASE_URL="${{ secrets.DATABASE_URL }}" npx prisma migrate deploy || echo "‚ö†Ô∏è  Migrations failed (continuing...)"
              fi
            fi
            
            # PM2 management
            echo "üîÑ Managing PM2 process..."
            pm2 delete xcited-web 2>/dev/null || true
            
            # Find server.js in standalone build structure (exclude node_modules)
            SERVER_JS=""
            if [ -f "server.js" ]; then
              SERVER_JS="server.js"
            elif [ -f ".next/standalone/server.js" ]; then
              SERVER_JS=".next/standalone/server.js"
            elif [ -f "standalone/server.js" ]; then
              SERVER_JS="standalone/server.js"
            else
              echo "üîç Searching for server.js (excluding node_modules)..."
              SERVER_JS=$(find . -name "server.js" -type f -not -path "*/node_modules/*" | head -1)
            fi
            
            if [ -z "$SERVER_JS" ] || [ ! -f "$SERVER_JS" ]; then
              echo "‚ö†Ô∏è  server.js not found"
              echo "üìÅ Current directory structure:"
              ls -la
              echo ""
              echo "üîç Searching for server.js (excluding node_modules)..."
              find . -name "server.js" -type f -not -path "*/node_modules/*" || echo "No server.js found"
              echo ""
              echo "‚ö†Ô∏è  Cannot start PM2 without server.js"
              echo "üí° VerificƒÉ dacƒÉ build-ul standalone a fost creat corect"
              exit 1
            fi
            
            echo "‚úÖ Found server.js at: $SERVER_JS"
            
            # Update ecosystem.config.js with correct server.js path
            if [ -f "ecosystem.config.js" ]; then
              # Update script path in ecosystem.config.js
              sed -i "s|script: 'server.js'|script: '$SERVER_JS'|g" ecosystem.config.js || true
              # Update cwd to current directory
              sed -i "s|cwd: '/home/xcited/public_html'|cwd: '$(pwd)'|g" ecosystem.config.js || true
              echo "üìã Starting PM2 with ecosystem.config.js..."
              pm2 start ecosystem.config.js
            else
              # Create ecosystem.config.js if it doesn't exist
              echo "üìù Creating ecosystem.config.js..."
              echo 'module.exports = {' > ecosystem.config.js
              echo '  apps: [{' >> ecosystem.config.js
              echo "    name: 'xcited-web'," >> ecosystem.config.js
              echo "    script: '$SERVER_JS'," >> ecosystem.config.js
              echo "    cwd: '$(pwd)'," >> ecosystem.config.js
              echo '    instances: 2,' >> ecosystem.config.js
              echo "    exec_mode: 'cluster'," >> ecosystem.config.js
              echo '    env: {' >> ecosystem.config.js
              echo "      NODE_ENV: 'production'," >> ecosystem.config.js
              echo '      PORT: 3001' >> ecosystem.config.js
              echo '    },' >> ecosystem.config.js
              echo "    error_file: '/var/log/pm2/xcited-web-error.log'," >> ecosystem.config.js
              echo "    out_file: '/var/log/pm2/xcited-web-out.log'," >> ecosystem.config.js
              echo "    log_date_format: 'YYYY-MM-DD HH:mm:ss Z'," >> ecosystem.config.js
              echo '    merge_logs: true,' >> ecosystem.config.js
              echo '    autorestart: true,' >> ecosystem.config.js
              echo "    max_memory_restart: '1G'" >> ecosystem.config.js
              echo '  }]' >> ecosystem.config.js
              echo '}' >> ecosystem.config.js
              pm2 start ecosystem.config.js
            fi
            
            pm2 save
            echo "‚úÖ Application started with PM2"
            
            # Verify application is running
            echo "üîç Verifying application..."
            sleep 3
            if pm2 describe xcited-web >/dev/null 2>&1; then
              echo "‚úÖ PM2 process xcited-web is running"
              pm2 list
            else
              echo "‚ö†Ô∏è  PM2 process xcited-web not found"
              pm2 list
            fi
            
            # Test if application responds on port 3001
            echo "üîç Testing application on port 3001..."
            if curl -f http://localhost:3001 >/dev/null 2>&1; then
              echo "‚úÖ Application responds on port 3001"
            else
              echo "‚ö†Ô∏è  Application does not respond on port 3001"
              echo "   Checking PM2 logs..."
              pm2 logs xcited-web --lines 20 --nostream || echo "   No logs available"
            fi
            
            # Final permissions check for Apache
            echo "üîç Final permissions check for Apache..."
            echo "   Target directory:"
            ls -ld "${TARGET}"
            echo "   Sample files:"
            ls -la "${TARGET}" | head -15
            echo "   Owner: $(stat -c '%U:%G' "${TARGET}" 2>/dev/null || echo 'unknown')"
            echo "   Permissions: $(stat -c '%a' "${TARGET}" 2>/dev/null || echo 'unknown')"
            
            # Check if Apache can access (if running as apache user)
            if id apache >/dev/null 2>&1; then
              echo "   Apache user exists, checking access..."
              # Apache should be able to read files with 644 and directories with 755
              if [ -r "${TARGET}" ]; then
                echo "   ‚úÖ Apache can read target directory"
              else
                echo "   ‚ö†Ô∏è  WARN: Apache may not be able to read target directory"
              fi
            fi
            
            # Check SELinux context (if applicable)
            if command -v getenforce >/dev/null 2>&1; then
              SELINUX_STATUS=$(getenforce 2>/dev/null || echo "Disabled")
              echo "   SELinux status: ${SELINUX_STATUS}"
              if [ "${SELINUX_STATUS}" != "Disabled" ]; then
                echo "   ‚ö†Ô∏è  WARN: SELinux is enabled - may need context fix"
                echo "      Run: sudo chcon -R -t httpd_sys_content_t ${TARGET}"
              fi
            fi

