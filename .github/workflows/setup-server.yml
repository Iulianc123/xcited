name: Setup xcited Server (CWP7pro)

on:
  workflow_dispatch:

jobs:
  setup-server:
    runs-on: ubuntu-latest
    steps:
      - name: Setup server infrastructure
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.CWP_HOST }}
          username: ${{ secrets.CWP_USER }}
          password: ${{ secrets.CWP_SSH_KEY }}
          port: ${{ secrets.CWP_PORT || 22 }}
          script: |
            set -e
            echo "ğŸ”§ Setting up xcited server infrastructure..."
            
            # Create user if it doesn't exist
            if ! id -u xcited >/dev/null 2>&1; then
              echo "ğŸ‘¤ Creating user xcited..."
              useradd -m -s /bin/bash xcited || echo "âš ï¸  User creation failed (may already exist)"
            else
              echo "âœ… User xcited already exists"
            fi
            
            # Create directory structure
            echo "ğŸ“ Creating directory structure..."
            mkdir -p /home/xcited/public_html
            chown -R xcited:xcited /home/xcited/public_html
            chmod 755 /home/xcited/public_html
            
            # Install Node.js 20 if not present
            if ! command -v node >/dev/null 2>&1 || [ "$(node -v | cut -d'v' -f2 | cut -d'.' -f1)" -lt 20 ]; then
              echo "ğŸ“¦ Installing Node.js 20..."
              curl -fsSL https://rpm.nodesource.com/setup_20.x | bash - || echo "âš ï¸  Node.js setup failed"
              yum install -y nodejs || echo "âš ï¸  Node.js install failed"
            else
              echo "âœ… Node.js already installed: $(node -v)"
            fi
            
            # Install PM2 if not present
            if ! command -v pm2 >/dev/null 2>&1; then
              echo "ğŸ“¦ Installing PM2..."
              npm install -g pm2 || echo "âš ï¸  PM2 install failed"
            else
              echo "âœ… PM2 already installed: $(pm2 -v)"
            fi
            
            # Configure PM2 startup
            echo "âš™ï¸  Configuring PM2 startup..."
            pm2 startup systemd -u root --hp /root 2>/dev/null || echo "âš ï¸  PM2 startup config failed (may already be configured)"
            
            # Create Apache reverse proxy configuration
            echo "ğŸŒ Configuring Apache reverse proxy..."
            echo '<VirtualHost *:80>' > /etc/httpd/conf.d/xcited.conf
            echo '    ServerName xcited.ro' >> /etc/httpd/conf.d/xcited.conf
            echo '    ServerAlias www.xcited.ro' >> /etc/httpd/conf.d/xcited.conf
            echo '' >> /etc/httpd/conf.d/xcited.conf
            echo '    ProxyPreserveHost On' >> /etc/httpd/conf.d/xcited.conf
            echo '    ProxyPass / http://localhost:3001/' >> /etc/httpd/conf.d/xcited.conf
            echo '    ProxyPassReverse / http://localhost:3001/' >> /etc/httpd/conf.d/xcited.conf
            echo '' >> /etc/httpd/conf.d/xcited.conf
            echo '    ErrorLog /var/log/httpd/xcited_error.log' >> /etc/httpd/conf.d/xcited.conf
            echo '    CustomLog /var/log/httpd/xcited_access.log combined' >> /etc/httpd/conf.d/xcited.conf
            echo '</VirtualHost>' >> /etc/httpd/conf.d/xcited.conf
            
            # Test Apache configuration
            if httpd -t 2>/dev/null; then
              echo "âœ… Apache configuration is valid"
              systemctl reload httpd || systemctl restart httpd || echo "âš ï¸  Apache reload failed"
            else
              echo "âš ï¸  Apache configuration has errors, check manually"
            fi
            
            echo "âœ… Server setup completed!"
            echo ""
            echo "ğŸ“‹ Summary:"
            echo "   - User: xcited"
            echo "   - Directory: /home/xcited/public_html"
            echo "   - Node.js: $(node -v 2>/dev/null || echo 'not installed')"
            echo "   - PM2: $(pm2 -v 2>/dev/null || echo 'not installed')"
            echo "   - Apache: reverse proxy configured for xcited.ro -> localhost:3001"

