name: Setup xcited Server (CWP7pro)

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/TRIGGER_SETUP_SERVER'

jobs:
  setup-server:
    runs-on: ubuntu-latest
    steps:
      - name: Setup server infrastructure
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.CWP_HOST }}
          username: ${{ secrets.CWP_USER }}
          password: ${{ secrets.CWP_SSH_KEY }}
          port: ${{ secrets.CWP_PORT || 22 }}
          script: |
            set -e
            echo "üîß Setting up xcited server infrastructure..."
            
            # Verify user exists (user should already exist since domain exists)
            if ! id -u xcited >/dev/null 2>&1; then
              echo "‚ö†Ô∏è  User xcited does not exist!"
              echo "   User should exist since domain xcited.ro exists"
              echo "   Please create user manually or check CWP7pro configuration"
              exit 1
            else
              echo "‚úÖ User xcited exists"
            fi
            
            # Create directory structure
            echo "üìÅ Creating directory structure..."
            mkdir -p /home/xcited/public_html
            chown -R xcited:xcited /home/xcited/public_html
            chmod 755 /home/xcited/public_html
            
            # Install Node.js 20 if not present
            if ! command -v node >/dev/null 2>&1 || [ "$(node -v | cut -d'v' -f2 | cut -d'.' -f1)" -lt 20 ]; then
              echo "üì¶ Installing Node.js 20..."
              curl -fsSL https://rpm.nodesource.com/setup_20.x | bash - || echo "‚ö†Ô∏è  Node.js setup failed"
              yum install -y nodejs || echo "‚ö†Ô∏è  Node.js install failed"
            else
              echo "‚úÖ Node.js already installed: $(node -v)"
            fi
            
            # Install PM2 if not present
            if ! command -v pm2 >/dev/null 2>&1; then
              echo "üì¶ Installing PM2..."
              npm install -g pm2 || echo "‚ö†Ô∏è  PM2 install failed"
            else
              echo "‚úÖ PM2 already installed: $(pm2 -v)"
            fi
            
            # Configure PM2 startup
            echo "‚öôÔ∏è  Configuring PM2 startup..."
            pm2 startup systemd -u root --hp /root 2>/dev/null || echo "‚ö†Ô∏è  PM2 startup config failed (may already be configured)"
            
            # Enable required Apache modules
            echo "üîß Enabling Apache modules..."
            a2enmod proxy proxy_http headers 2>/dev/null || {
              echo "   a2enmod not available (CentOS/RHEL), modules should be enabled in main config"
            }
            
            # Create Apache reverse proxy configuration
            echo "üåê Configuring Apache reverse proxy..."
            
            # Backup existing config if it exists
            if [ -f /etc/httpd/conf.d/xcited.conf ]; then
              cp /etc/httpd/conf.d/xcited.conf /etc/httpd/conf.d/xcited.conf.backup.$(date +%s)
              echo "   ‚úÖ Backed up existing config"
            fi
            
            # Create new Apache config using echo (avoid YAML heredoc issues)
            # CRITICAL: ProxyPass must come BEFORE Directory directive to avoid Forbidden errors
            echo '<VirtualHost *:80>' > /etc/httpd/conf.d/xcited.conf
            echo '    ServerName xcited.ro' >> /etc/httpd/conf.d/xcited.conf
            echo '    ServerAlias www.xcited.ro' >> /etc/httpd/conf.d/xcited.conf
            echo '' >> /etc/httpd/conf.d/xcited.conf
            echo '    # Reverse Proxy Configuration (MUST be first to avoid Forbidden)' >> /etc/httpd/conf.d/xcited.conf
            echo '    ProxyPreserveHost On' >> /etc/httpd/conf.d/xcited.conf
            echo '    ProxyPass / http://127.0.0.1:3002/' >> /etc/httpd/conf.d/xcited.conf
            echo '    ProxyPassReverse / http://127.0.0.1:3002/' >> /etc/httpd/conf.d/xcited.conf
            echo '    ProxyRequests Off' >> /etc/httpd/conf.d/xcited.conf
            echo '    ProxyTimeout 300' >> /etc/httpd/conf.d/xcited.conf
            echo '' >> /etc/httpd/conf.d/xcited.conf
            echo '    # Headers for Next.js' >> /etc/httpd/conf.d/xcited.conf
            echo '    RequestHeader set X-Forwarded-Proto "http"' >> /etc/httpd/conf.d/xcited.conf
            echo '    RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}e"' >> /etc/httpd/conf.d/xcited.conf
            echo '' >> /etc/httpd/conf.d/xcited.conf
            echo '    # DocumentRoot (not used, but required for Apache)' >> /etc/httpd/conf.d/xcited.conf
            echo '    DocumentRoot /home/xcited/public_html' >> /etc/httpd/conf.d/xcited.conf
            echo '' >> /etc/httpd/conf.d/xcited.conf
            echo '    <Directory /home/xcited/public_html>' >> /etc/httpd/conf.d/xcited.conf
            echo '        Options -Indexes +FollowSymLinks' >> /etc/httpd/conf.d/xcited.conf
            echo '        AllowOverride None' >> /etc/httpd/conf.d/xcited.conf
            echo '        Require all granted' >> /etc/httpd/conf.d/xcited.conf
            echo '    </Directory>' >> /etc/httpd/conf.d/xcited.conf
            echo '' >> /etc/httpd/conf.d/xcited.conf
            echo '    # Proxy settings' >> /etc/httpd/conf.d/xcited.conf
            echo '    ProxyRequests Off' >> /etc/httpd/conf.d/xcited.conf
            echo '    ProxyTimeout 300' >> /etc/httpd/conf.d/xcited.conf
            echo '' >> /etc/httpd/conf.d/xcited.conf
            echo '    # Headers for Next.js' >> /etc/httpd/conf.d/xcited.conf
            echo '    RequestHeader set X-Forwarded-Proto "http"' >> /etc/httpd/conf.d/xcited.conf
            echo '    RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}e"' >> /etc/httpd/conf.d/xcited.conf
            echo '' >> /etc/httpd/conf.d/xcited.conf
            echo '    # Error handling' >> /etc/httpd/conf.d/xcited.conf
            echo '    ProxyErrorOverride Off' >> /etc/httpd/conf.d/xcited.conf
            echo '' >> /etc/httpd/conf.d/xcited.conf
            echo '    # Logging' >> /etc/httpd/conf.d/xcited.conf
            echo '    ErrorLog /var/log/httpd/xcited_error.log' >> /etc/httpd/conf.d/xcited.conf
            echo '    CustomLog /var/log/httpd/xcited_access.log combined' >> /etc/httpd/conf.d/xcited.conf
            echo '    LogLevel warn' >> /etc/httpd/conf.d/xcited.conf
            echo '</VirtualHost>' >> /etc/httpd/conf.d/xcited.conf
            
            echo "   ‚úÖ Apache config created at /etc/httpd/conf.d/xcited.conf"
            
            # Verify Apache config syntax
            echo "üîç Testing Apache configuration..."
            
            # Find Apache/httpd command (CWP7pro may have it in different locations)
            HTTPD_CMD=""
            for cmd in "/usr/sbin/httpd" "/usr/local/apache/bin/httpd" "/usr/bin/httpd" "httpd" "/usr/sbin/apache2ctl" "/usr/bin/apache2ctl" "apache2ctl"; do
              if command -v "$cmd" >/dev/null 2>&1 || [ -f "$cmd" ]; then
                HTTPD_CMD="$cmd"
                break
              fi
            done
            
            if [ -n "$HTTPD_CMD" ]; then
              echo "   Found Apache command: $HTTPD_CMD"
              
              # Test configuration (may need sudo)
              if sudo -n "$HTTPD_CMD" -t 2>/dev/null || "$HTTPD_CMD" -t 2>/dev/null; then
                echo "   ‚úÖ Apache configuration is valid"
                
                # Reload Apache
                echo "üîÑ Reloading Apache..."
                if sudo -n systemctl reload httpd 2>/dev/null || systemctl reload httpd 2>/dev/null; then
                  echo "   ‚úÖ Apache reloaded successfully"
                elif sudo -n systemctl restart httpd 2>/dev/null || systemctl restart httpd 2>/dev/null; then
                  echo "   ‚úÖ Apache restarted successfully"
                elif sudo -n systemctl reload apache2 2>/dev/null || systemctl reload apache2 2>/dev/null; then
                  echo "   ‚úÖ Apache reloaded successfully"
                elif sudo -n systemctl restart apache2 2>/dev/null || systemctl restart apache2 2>/dev/null; then
                  echo "   ‚úÖ Apache restarted successfully"
                else
                  echo "   ‚ö†Ô∏è  Apache reload/restart failed"
                  echo "   Configuration file created at: /etc/httpd/conf.d/xcited.conf"
                  echo "   Please restart Apache manually: sudo systemctl restart httpd"
                fi
              else
                echo "   ‚ö†Ô∏è  Could not test Apache configuration (may need sudo)"
                echo "   Configuration file created at: /etc/httpd/conf.d/xcited.conf"
                echo "   Please test manually: sudo $HTTPD_CMD -t"
              fi
            else
              echo "   ‚ö†Ô∏è  Apache command not found in PATH"
              echo "   Configuration file created at: /etc/httpd/conf.d/xcited.conf"
              echo "   Please test and restart Apache manually:"
              echo "     sudo /usr/sbin/httpd -t"
              echo "     sudo systemctl restart httpd"
            fi
            
            # Verify Apache can access localhost:3002
            echo "üîç Verifying Apache can access localhost:3002..."
            if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3002 2>/dev/null | grep -q "200\|404\|500"; then
              echo "   ‚úÖ Application responds on localhost:3002"
            else
              echo "   ‚ö†Ô∏è  Application may not be running on localhost:3002 yet"
              echo "   This is normal if the app hasn't been deployed yet"
            fi
            
            echo "‚úÖ Server setup completed!"
            echo ""
            echo "üìã Summary:"
            echo "   - User: xcited"
            echo "   - Directory: /home/xcited/public_html"
            echo "   - Node.js: $(node -v 2>/dev/null || echo 'not installed')"
            echo "   - PM2: $(pm2 -v 2>/dev/null || echo 'not installed')"
            echo "   - Apache: reverse proxy configured for xcited.ro -> localhost:3002"

