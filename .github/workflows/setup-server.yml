name: Setup xcited Server (CWP7pro)

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/TRIGGER_SETUP_SERVER'

jobs:
  setup-server:
    runs-on: ubuntu-latest
    steps:
      - name: Setup server infrastructure
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.CWP_HOST }}
          username: ${{ secrets.CWP_USER }}
          password: ${{ secrets.CWP_SSH_KEY }}
          port: ${{ secrets.CWP_PORT || 22 }}
          script: |
            set -e
            echo "üîß Setting up xcited server infrastructure..."
            
            # Verify user exists (user should already exist since domain exists)
            if ! id -u xcited >/dev/null 2>&1; then
              echo "‚ö†Ô∏è  User xcited does not exist!"
              echo "   User should exist since domain xcited.ro exists"
              echo "   Please create user manually or check CWP7pro configuration"
              exit 1
            else
              echo "‚úÖ User xcited exists"
            fi
            
            # Create directory structure
            echo "üìÅ Creating directory structure..."
            mkdir -p /home/xcited/public_html
            chown -R xcited:xcited /home/xcited/public_html
            chmod 755 /home/xcited/public_html
            
            # Install Node.js 20 if not present
            if ! command -v node >/dev/null 2>&1 || [ "$(node -v | cut -d'v' -f2 | cut -d'.' -f1)" -lt 20 ]; then
              echo "üì¶ Installing Node.js 20..."
              curl -fsSL https://rpm.nodesource.com/setup_20.x | bash - || echo "‚ö†Ô∏è  Node.js setup failed"
              yum install -y nodejs || echo "‚ö†Ô∏è  Node.js install failed"
            else
              echo "‚úÖ Node.js already installed: $(node -v)"
            fi
            
            # Install PM2 if not present
            if ! command -v pm2 >/dev/null 2>&1; then
              echo "üì¶ Installing PM2..."
              npm install -g pm2 || echo "‚ö†Ô∏è  PM2 install failed"
            else
              echo "‚úÖ PM2 already installed: $(pm2 -v)"
            fi
            
            # Configure PM2 startup
            echo "‚öôÔ∏è  Configuring PM2 startup..."
            pm2 startup systemd -u root --hp /root 2>/dev/null || echo "‚ö†Ô∏è  PM2 startup config failed (may already be configured)"
            
            # Enable required Apache modules
            echo "üîß Enabling Apache modules..."
            a2enmod proxy proxy_http headers 2>/dev/null || {
              echo "   a2enmod not available (CentOS/RHEL), modules should be enabled in main config"
            }
            
            # Create Apache reverse proxy configuration
            echo "üåê Configuring Apache reverse proxy..."
            
            # Backup existing config if it exists
            if [ -f /etc/httpd/conf.d/xcited.conf ]; then
              cp /etc/httpd/conf.d/xcited.conf /etc/httpd/conf.d/xcited.conf.backup.$(date +%s)
              echo "   ‚úÖ Backed up existing config"
            fi
            
            # Create new Apache config using echo (avoid YAML heredoc issues)
            echo '<VirtualHost *:80>' > /etc/httpd/conf.d/xcited.conf
            echo '    ServerName xcited.ro' >> /etc/httpd/conf.d/xcited.conf
            echo '    ServerAlias www.xcited.ro' >> /etc/httpd/conf.d/xcited.conf
            echo '' >> /etc/httpd/conf.d/xcited.conf
            echo '    # Disable DocumentRoot serving (we use reverse proxy)' >> /etc/httpd/conf.d/xcited.conf
            echo '    DocumentRoot /home/xcited/public_html' >> /etc/httpd/conf.d/xcited.conf
            echo '' >> /etc/httpd/conf.d/xcited.conf
            echo '    <Directory /home/xcited/public_html>' >> /etc/httpd/conf.d/xcited.conf
            echo '        Options -Indexes +FollowSymLinks' >> /etc/httpd/conf.d/xcited.conf
            echo '        AllowOverride None' >> /etc/httpd/conf.d/xcited.conf
            echo '        Require all granted' >> /etc/httpd/conf.d/xcited.conf
            echo '    </Directory>' >> /etc/httpd/conf.d/xcited.conf
            echo '' >> /etc/httpd/conf.d/xcited.conf
            echo '    # Reverse Proxy Configuration' >> /etc/httpd/conf.d/xcited.conf
            echo '    ProxyPreserveHost On' >> /etc/httpd/conf.d/xcited.conf
            echo '    ProxyPass / http://127.0.0.1:3002/' >> /etc/httpd/conf.d/xcited.conf
            echo '    ProxyPassReverse / http://127.0.0.1:3002/' >> /etc/httpd/conf.d/xcited.conf
            echo '' >> /etc/httpd/conf.d/xcited.conf
            echo '    # Proxy settings' >> /etc/httpd/conf.d/xcited.conf
            echo '    ProxyRequests Off' >> /etc/httpd/conf.d/xcited.conf
            echo '    ProxyTimeout 300' >> /etc/httpd/conf.d/xcited.conf
            echo '' >> /etc/httpd/conf.d/xcited.conf
            echo '    # Headers for Next.js' >> /etc/httpd/conf.d/xcited.conf
            echo '    RequestHeader set X-Forwarded-Proto "http"' >> /etc/httpd/conf.d/xcited.conf
            echo '    RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}e"' >> /etc/httpd/conf.d/xcited.conf
            echo '' >> /etc/httpd/conf.d/xcited.conf
            echo '    # Error handling' >> /etc/httpd/conf.d/xcited.conf
            echo '    ProxyErrorOverride Off' >> /etc/httpd/conf.d/xcited.conf
            echo '' >> /etc/httpd/conf.d/xcited.conf
            echo '    # Logging' >> /etc/httpd/conf.d/xcited.conf
            echo '    ErrorLog /var/log/httpd/xcited_error.log' >> /etc/httpd/conf.d/xcited.conf
            echo '    CustomLog /var/log/httpd/xcited_access.log combined' >> /etc/httpd/conf.d/xcited.conf
            echo '    LogLevel warn' >> /etc/httpd/conf.d/xcited.conf
            echo '</VirtualHost>' >> /etc/httpd/conf.d/xcited.conf
            
            echo "   ‚úÖ Apache config created at /etc/httpd/conf.d/xcited.conf"
            
            # Verify Apache config syntax
            echo "üîç Testing Apache configuration..."
            if httpd -t 2>/dev/null || apache2ctl -t 2>/dev/null; then
              echo "   ‚úÖ Apache configuration is valid"
              
              # Reload Apache
              echo "üîÑ Reloading Apache..."
              if systemctl reload httpd 2>/dev/null || systemctl reload apache2 2>/dev/null; then
                echo "   ‚úÖ Apache reloaded successfully"
              elif systemctl restart httpd 2>/dev/null || systemctl restart apache2 2>/dev/null; then
                echo "   ‚úÖ Apache restarted successfully"
              else
                echo "   ‚ö†Ô∏è  Apache reload/restart failed, may need manual restart"
              fi
            else
              echo "   ‚ùå Apache configuration has errors!"
              echo "   Checking syntax errors..."
              httpd -t 2>&1 || apache2ctl -t 2>&1 || true
              echo "   ‚ö†Ô∏è  Please fix Apache configuration manually"
            fi
            
            # Verify Apache can access localhost:3002
            echo "üîç Verifying Apache can access localhost:3002..."
            if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3002 | grep -q "200\|404\|500"; then
              echo "   ‚úÖ Apache can access localhost:3002"
            else
              echo "   ‚ö†Ô∏è  WARN: Apache may not be able to access localhost:3002"
              echo "   This is normal if the app is not running yet"
            fi
            
            echo "‚úÖ Server setup completed!"
            echo ""
            echo "üìã Summary:"
            echo "   - User: xcited"
            echo "   - Directory: /home/xcited/public_html"
            echo "   - Node.js: $(node -v 2>/dev/null || echo 'not installed')"
            echo "   - PM2: $(pm2 -v 2>/dev/null || echo 'not installed')"
            echo "   - Apache: reverse proxy configured for xcited.ro -> localhost:3002"

