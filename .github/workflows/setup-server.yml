name: Setup xcited Server (CWP7pro)

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/TRIGGER_SETUP_SERVER'

jobs:
  setup-server:
    runs-on: ubuntu-latest
    steps:
      - name: Setup server infrastructure
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.CWP_HOST }}
          username: ${{ secrets.CWP_USER }}
          password: ${{ secrets.CWP_SSH_KEY }}
          port: ${{ secrets.CWP_PORT || 22 }}
          script: |
            set -e
            echo "ðŸ”§ Setting up xcited server infrastructure..."
            
            # Verify user exists (user should already exist since domain exists)
            if ! id -u xcited >/dev/null 2>&1; then
              echo "âš ï¸  User xcited does not exist!"
              echo "   User should exist since domain xcited.ro exists"
              echo "   Please create user manually or check CWP7pro configuration"
              exit 1
            else
              echo "âœ… User xcited exists"
            fi
            
            # Create directory structure
            echo "ðŸ“ Creating directory structure..."
            mkdir -p /home/xcited/public_html
            chown -R xcited:xcited /home/xcited/public_html
            chmod 755 /home/xcited/public_html
            
            # Install Node.js 20 if not present
            if ! command -v node >/dev/null 2>&1 || [ "$(node -v | cut -d'v' -f2 | cut -d'.' -f1)" -lt 20 ]; then
              echo "ðŸ“¦ Installing Node.js 20..."
              curl -fsSL https://rpm.nodesource.com/setup_20.x | bash - || echo "âš ï¸  Node.js setup failed"
              yum install -y nodejs || echo "âš ï¸  Node.js install failed"
            else
              echo "âœ… Node.js already installed: $(node -v)"
            fi
            
            # Install PM2 if not present
            if ! command -v pm2 >/dev/null 2>&1; then
              echo "ðŸ“¦ Installing PM2..."
              npm install -g pm2 || echo "âš ï¸  PM2 install failed"
            else
              echo "âœ… PM2 already installed: $(pm2 -v)"
            fi
            
            # Configure PM2 startup
            echo "âš™ï¸  Configuring PM2 startup..."
            pm2 startup systemd -u root --hp /root 2>/dev/null || echo "âš ï¸  PM2 startup config failed (may already be configured)"
            
            # Enable required Apache modules
            echo "ðŸ”§ Enabling Apache modules..."
            a2enmod proxy proxy_http headers 2>/dev/null || {
              echo "   a2enmod not available (CentOS/RHEL), modules should be enabled in main config"
            }
            
            # Create Apache reverse proxy configuration
            echo "ðŸŒ Configuring Apache reverse proxy..."
            
            # Backup existing config if it exists
            if [ -f /etc/httpd/conf.d/xcited.conf ]; then
              cp /etc/httpd/conf.d/xcited.conf /etc/httpd/conf.d/xcited.conf.backup.$(date +%s)
              echo "   âœ… Backed up existing config"
            fi
            
            # Create new Apache config
            cat > /etc/httpd/conf.d/xcited.conf << 'APACHE_EOF'
<VirtualHost *:80>
    ServerName xcited.ro
    ServerAlias www.xcited.ro
    
    # Disable DocumentRoot serving (we use reverse proxy)
    DocumentRoot /home/xcited/public_html
    
    <Directory /home/xcited/public_html>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>
    
    # Reverse Proxy Configuration
    ProxyPreserveHost On
    ProxyPass / http://127.0.0.1:3002/
    ProxyPassReverse / http://127.0.0.1:3002/
    
    # Proxy settings
    ProxyRequests Off
    ProxyTimeout 300
    
    # Headers for Next.js
    RequestHeader set X-Forwarded-Proto "http"
    RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}e"
    
    # Error handling
    ProxyErrorOverride Off
    
    # Logging
    ErrorLog /var/log/httpd/xcited_error.log
    CustomLog /var/log/httpd/xcited_access.log combined
    LogLevel warn
</VirtualHost>
APACHE_EOF
            
            echo "   âœ… Apache config created at /etc/httpd/conf.d/xcited.conf"
            
            # Verify Apache config syntax
            echo "ðŸ” Testing Apache configuration..."
            if httpd -t 2>/dev/null || apache2ctl -t 2>/dev/null; then
              echo "   âœ… Apache configuration is valid"
              
              # Reload Apache
              echo "ðŸ”„ Reloading Apache..."
              if systemctl reload httpd 2>/dev/null || systemctl reload apache2 2>/dev/null; then
                echo "   âœ… Apache reloaded successfully"
              elif systemctl restart httpd 2>/dev/null || systemctl restart apache2 2>/dev/null; then
                echo "   âœ… Apache restarted successfully"
              else
                echo "   âš ï¸  Apache reload/restart failed, may need manual restart"
              fi
            else
              echo "   âŒ Apache configuration has errors!"
              echo "   Checking syntax errors..."
              httpd -t 2>&1 || apache2ctl -t 2>&1 || true
              echo "   âš ï¸  Please fix Apache configuration manually"
            fi
            
            # Verify Apache can access localhost:3002
            echo "ðŸ” Verifying Apache can access localhost:3002..."
            if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3002 | grep -q "200\|404\|500"; then
              echo "   âœ… Apache can access localhost:3002"
            else
              echo "   âš ï¸  WARN: Apache may not be able to access localhost:3002"
              echo "   This is normal if the app is not running yet"
            fi
            
            echo "âœ… Server setup completed!"
            echo ""
            echo "ðŸ“‹ Summary:"
            echo "   - User: xcited"
            echo "   - Directory: /home/xcited/public_html"
            echo "   - Node.js: $(node -v 2>/dev/null || echo 'not installed')"
            echo "   - PM2: $(pm2 -v 2>/dev/null || echo 'not installed')"
            echo "   - Apache: reverse proxy configured for xcited.ro -> localhost:3002"

